## PowerShell + C# binary cmdlet

* PowerShell v6+ & Windows PowerShell 5.1+ éƒ½æ”¯æ´ä½¿ç”¨ C# ä¾†æ’°å¯« binary cmdlet ä¾†æ“´å…… PowerShell çš„åŠŸèƒ½ã€‚
* é€é C# çš„å¼·å‹åˆ¥ã€é«˜æ•ˆèƒ½ã€å¤šåŸ·è¡Œç·’ç­‰ç‰¹æ€§ä¾†æ’°å¯« PowerShell çš„ binary cmdletï¼Œå¯ä»¥æé«˜ PowerShell scriptçš„åŸ·è¡Œæ•ˆèƒ½ã€‚
* ä¸€äº› PowerShell åŸç”Ÿæ²’æœ‰æä¾›çš„åŠŸèƒ½å¯é€é C# ä¾†æ’°å¯« binary cmdlet ä¾†æ“´å…… PowerShell çš„ä½¿ç”¨ç¯„åœã€‚

but... C# binary cmdlet çš„æ¸¬è©¦æ¡ˆä¾‹æ’°å¯«ç›¸å°è¼ƒå›°é›£ğŸ˜µ

## PowerShell C# binary cmdlet çš„ç°¡å–®ç¯„ä¾‹ {.scrollable}

### ***Demo***

[ç¯„ä¾‹ç¨‹å¼ç¢¼ GitHub](http://github.com/windperson/BinaryPwshModuleDemo)

* ä½¿ç”¨ [`PowerShell.Standard.Library` Nuget å¥—ä»¶](http://www.nuget.org/packages/PowerShellStandard.Library/)çš„ binary cmdlet å¯åœ¨ Windows PowerShell v5.1+ & PowerShell v7+ ç’°å¢ƒä¸­åŸ·è¡Œã€‚
* ä½¿ç”¨ [`System.Management.Automation` Nuget å¥—ä»¶](http://www.nuget.org/packages/System.Management.Automation/)çš„ binary cmdlet åƒ…èƒ½åœ¨ PowerShell Core/v7+ ç’°å¢ƒä¸­åŸ·è¡Œã€‚
* ç¹¼æ‰¿ [`Cmdlet`](http://learn.microsoft.com/dotnet/api/system.management.automation.cmdlet) é¡åˆ¥ä¾†æ’°å¯« PowerShell Simple function çš„ binary cmdlet å¯¦ä½œã€‚
* ç¹¼æ‰¿ [`PSCmdlet`](http://learn.microsoft.com/dotnet/api/system.management.automation.pscmdlet) é¡åˆ¥ä¾†æ’°å¯« [PowerShell Advanced function](http://learn.microsoft.com/powershell/module/microsoft.powershell.core/about/about_functions_advanced) çš„ binary cmdlet å¯¦ä½œã€‚
* ä½¿ç”¨ C# xUnitæ¸¬è©¦æ¡†æ¶ä¾†æ’°å¯«ç¹¼æ‰¿ `Cmdlet` çš„æ¸¬è©¦æ¡ˆä¾‹ã€‚

::: {.callout-tip}
ä½¿ç”¨ VSCode ä¾†è·‘åµéŒ¯ PowerShell binary cmdlet æ™‚ï¼Œæ³¨æ„ launch.json çš„ console éœ€è¨­å®šç‚º "**integratedTerminal**"ï¼Œå¦å‰‡ç„¡æ³•æ­£ç¢ºåœåœ¨ debug pointã€‚
:::

```json{.json filename=".vscode/launch.json" code-line-numbers="5,8,17,22,25,34"}
{
     "configurations": [
        {
            "name": "NetStandard module Pwsh CLI",
            "type": "coreclr",
            "request": "launch",
            "preLaunchTask": "build netstandard module",
            "program": "pwsh",
            "args": [
                "-NoExit",
                "-NoProfile",
                "-Command",
                "Import-Module ${workspaceFolder}/src/PwshStandardModule/bin/Debug/netstandard2.0/PwshStandardModule.dll"
            ],
            "cwd": "${workspaceFolder}",
            "stopAtEntry": false,
            "console": "integratedTerminal"
        },
        {
            // NOTE: this task is Windows only
            "name": "NetStandard module Windows PowerShell CLI",
            "type": "clr",
            "request": "launch",
            "preLaunchTask": "build netstandard module",
            "program": "powerShell",
            "args": [
                "-NoExit",
                "-NoProfile",
                "-Command",
                "Import-Module ${workspaceFolder}/src/PwshStandardModule/bin/Debug/netstandard2.0/PwshStandardModule.dll"
            ],
            "cwd": "${workspaceFolder}",
            "stopAtEntry": false,
            "console": "integratedTerminal"
        }
    ]
}
```


## **(PowerShell + C# binary cmdlet)** call gRPC API

### ***Demo***

[ç¯„ä¾‹ç¨‹å¼ç¢¼ GitHub](http://github.com/windperson/MultiPlatformPwshCmdletDemo)

* ä½¿ç”¨ [gRPC-web](https://devblogs.microsoft.com/dotnet/grpc-web-experiment/) çš„ C# Client Nuget å¥—ä»¶ä»¥ä¾¿åœ¨ä¸æ”¯æ´ HTTP/2 çš„ Windows PowerShell ç’°å¢ƒä¸­å‘¼å« gRPC æœå‹™ã€‚
   * å¦‚ä½•ç‚º Windows PowerShell çš„ C# binary cmdlet æ’°å¯« Assembly Resolver ä»¥ä¾¿æˆåŠŸè¼‰å…¥ gRPC-Web client Libraryã€‚
* ç¹¼æ‰¿ [`PSCmdlet`](http://learn.microsoft.com/dotnet/api/system.management.automation.pscmdlet) é¡åˆ¥æ‰€æ’°å¯« [PowerShell Advanced function](http://learn.microsoft.com/powershell/module/microsoft.powershell.core/about/about_functions_advanced) çš„ binary cmdlet å¦‚ä½•ä½¿ç”¨ xUnit æ¸¬è©¦æ¡†æ¶ä¾†æ’°å¯«æ¸¬è©¦æ¡ˆä¾‹ã€‚
* ä½¿ç”¨æ··åˆ PowerShell .psd1 è¨­å®šæª” + C# binary cmdlet çš„æ–¹å¼ä¾†æ’°å¯«æ··åˆå‹ PowerShell Module å°ˆæ¡ˆã€‚
    * å¦‚ä½•æ–¼ Windows PowerShell v5.1 & PowerShell v7+ è·‘åµéŒ¯ã€‚
    * å¦‚ä½•é‡å° PowerShell + C# ç¨‹å¼ç¢¼çš„å°ˆæ¡ˆæ’°å¯« PowerShell çš„ Pester æ¸¬è©¦æ¡ˆä¾‹ã€‚

## {.smaller .scrollable}

gRPC-Web çš„ç›¸ä¾ Assembly dll ç‰ˆæœ¬æ¯”åŸæœ¬ Windows PowerShell v5.1 æ‰€ä½¿ç”¨çš„ç‰ˆæœ¬æ–°ï¼Œéœ€è¦å¯«é¡å¤–çš„ Assembly Resolver ç¨‹å¼ç¢¼æ§åˆ¶ .NET Framework CLR è¼‰å…¥ dll æ©Ÿåˆ¶ã€‚

```csharp{.cs filename="Pwsh\GreeterCmdlet\WindowsPowerShellModuleInitializer.cs" code-line-numbers="false"}
#if NETSTANDARD2_0
using System.Management.Automation;
using System.Reflection;

namespace GreeterCmdlet;

public class WindowsPowerShellModuleInitializer : IModuleAssemblyInitializer                                       // <1>
{                                                                                                                  // <1>
    public void OnImport()                                                                                         // <1>
    {                                                                                                              // <1>
        AppDomain.CurrentDomain.AssemblyResolve += DependencyResolution.ResoleAssembly;                            // <1>
    }                                                                                                              // <1>
}                                                                                                                  // <1>

public class WindowsPowerShellModuleCleanup : IModuleAssemblyCleanup                                               // <2>
{                                                                                                                  // <2>
    public void OnRemove(PSModuleInfo psModuleInfo)                                                                // <2>
    {                                                                                                              // <2>
        AppDomain.CurrentDomain.AssemblyResolve -= DependencyResolution.ResoleAssembly;                            // <2>
    }                                                                                                              // <2>
}                                                                                                                  // <2>

internal static class DependencyResolution
{
    private static readonly string ModulePath = 
                                Path.GetDirectoryName(Assembly.GetExecutingAssembly().Location)!;

    public static Assembly ResoleAssembly(object? sender, ResolveEventArgs args)
    {
        var assemblyName = new AssemblyName(args.Name);
        if (assemblyName.Name == "System.Buffers")                                                                 // <3>
        {                                                                                                          // <3>
            return Assembly.LoadFrom(Path.Combine(ModulePath, "System.Buffers.dll"));                              // <3>
        }                                                                                                          // <3>
        
        if (assemblyName.Name == "System.Runtime.CompilerServices.Unsafe")                                         // <4>
        {                                                                                                          // <4>
            return Assembly.LoadFrom(Path.Combine(ModulePath, "System.Runtime.CompilerServices.Unsafe.dll"));      // <4>
        }                                                                                                          // <4>

        return null!;
    }
}
#endif
```
1. å¯¦ä½œ `IModuleAssemblyInitializer` ä»‹é¢è¨»å†Š Assembly Resolver äº‹ä»¶è™•ç†å‡½å¼ã€‚
2. å¯¦ä½œ `IModuleAssemblyCleanup` ä»‹é¢ç§»é™¤ Assembly Resolver äº‹ä»¶è™•ç†å‡½å¼ã€‚
3. é‡å° gRPC-Web client å¥—ä»¶ç›¸ä¾ `Systems.Buffers.dll` çš„ Assembly Resolver å¯¦ä½œï¼Œç›´æ¥è¼‰å…¥åŒç›®éŒ„ç”± MSBuild ä¸€èµ· copy éä¾†çš„ dll ç‰ˆæœ¬ã€‚
4. é‡å° `Systems.Buffers` ç›¸ä¾ `System.Runtime.CompilerServices.Unsafe.dll` çš„ Assembly Resolver å¯¦ä½œï¼Œç›´æ¥è¼‰å…¥åŒç›®éŒ„ç”± MSBuild ä¸€èµ· copy éä¾†çš„ dll ç‰ˆæœ¬ã€‚

## {.smaller .scrollable}

å°‡å¯¦éš›å‘¼å« gRPC æœå‹™çš„ C# ç¨‹å¼èˆ‡ Binary Cmdlet å°ˆæ¡ˆçš„åˆ†é–‹ä¸¦å®šç¾©ä»‹é¢ `IGreetingGrpcClient`ï¼Œä»¥ä¾¿æ–¼ç¨å¾Œæ’°å¯«æ¸¬è©¦æ¡ˆä¾‹ã€‚

```csharp{.cs filename="Pwsh\GreeterCmdlet\CallGreetingClientLibCmdlet.cs" code-line-numbers="10,32-40"}
[Cmdlet(VerbsCommunications.Send, "GreeterGrpcApi")]
[OutputType(typeof(GreetingResponse))]
public class CallGreetingClientLibCmdlet : PSCmdlet
{
    [Parameter(Mandatory = true, Position = 0)]
    public string Server { get; set; } = string.Empty;

    [Parameter(Mandatory = true)] public GreetingRequest Request { get; set; } = null!;

    [Parameter(Mandatory = false)] public IGreetingGrpcClient ApiClient { get; set; } = new GreetingClient();

    protected override void BeginProcessing()
    {
        if (ApiClient is GreetingClient greetingClient)
        {
            greetingClient.ServerUrl = $"https://{Server}";
        }
    }

    protected override void ProcessRecord()
    {
        try
        {
            var reply = ApiClient.GetGreeting(Request);
            WriteObject(reply);
        }
        catch (Exception ex) {
            /* handle exception */
        }
    }

    /// <summary>
    /// This method is used for testing purposes only.
    /// </summary>
    internal void ProcessInternalForTest()
    {
        BeginProcessing();
        ProcessRecord();
        EndProcessing();
    }
}
```

::: {.callout-note collapse=true}
35~40è¡Œæ˜¯ç‚ºäº†è¦åœ¨æ¸¬è©¦ç¨‹å¼ç¢¼ä¸­æ¨¡æ“¬ PSCmdlet çš„ PowerShell runtime åŸ·è¡Œç’°å¢ƒï¼Œä»¥ä¾¿è®“æ¸¬è©¦ç¨‹å¼å‘¼å« PowerShell Cmdlet æä¾›çš„ `BeginProcessing()`,  `ProcessRecord()`,  `EndProcessing()` é€™ä¸‰å€‹ API å¯¦ä½œæ–¹æ³•ä¾åºåŸ·è¡Œçš„å…§è—å‡½å¼ï¼Œä¸¦åœ¨æ­¤å°ˆæ¡ˆçš„ .csproj è¨­å®šæª”ä¸­å®£å‘Š `<InternalVisible>...</InternalVisible>`è®“ xUnit æ¸¬è©¦å°ˆæ¡ˆæœ‰æ¬Šé™å¯ä»¥åŸ·è¡Œæ­¤æ–¹æ³•ã€‚
:::

å¯¦éš›å¯« xUnit test case æ™‚ï¼Œå¯ç”¨ [`Moq` nuget å¥—ä»¶](https://www.nuget.org/packages/Moq)æä¾›çš„åŠŸèƒ½ç”¢ç”Ÿ `Mock<IGreetingGrpcClient>` ç‰©ä»¶ä¾†æ¨¡æ“¬å‘¼å« gRPC æœå‹™çš„è¡Œç‚ºã€‚

```csharp{.cs filename="tests\csharp\GreeterCmdletTests\CallGreetingClientLibCmdletTests.cs" code-line-numbers="false"}
[Fact]
public void ProcessRecord_ShouldWriteObject_WhenApiClientReturnsResponse()
{
    // Arrange
    var mockApiClient = new Mock<IGreetingGrpcClient>();                     // <1>
    var request = new GreetingRequest("Test");                               // <1>
    var response = new GreetingResponse("Hello, Test!");                     // <1>
    mockApiClient.Setup(client => client.GetGreeting(request))               // <1>
                    .Returns(response);                                      // <1>
                    
    var cmdlet = new CallGreetingClientLibCmdlet
    {
        Server = "localhost",
        Request = request,
        ApiClient = mockApiClient.Object
    };

    // Act
    var pipelineEmulator = new CommandRuntimeEmulator();                     // <2>
    cmdlet.CommandRuntime = pipelineEmulator;                                // <2>
    cmdlet.ProcessInternalForTest();                                         // <2>

    // Assert
    var results = pipelineEmulator.OutputObjects;
    Assert.Single(results);
    var actualResponse = results.First() as GreetingResponse;
    Assert.NotNull(actualResponse);
    Assert.Equal(response.Message, actualResponse.Message);
}
```
1. å»ºç«‹ `Mock<IGreetingGrpcClient>` ä¾†æ¨¡æ“¬å‘¼å« gRPC æœå‹™çš„è¡Œç‚ºï¼Œå°±ä¸éœ€åœ¨è·‘æ¸¬è©¦æ™‚ä½¿ç”¨å¯¦éš›çš„ gRPC Server æœå‹™ã€‚
2. ä½¿ç”¨ `CommandRuntimeEmulator` é€™å€‹è‡ªè£½çš„å¯¦ä½œ [`ICommandRuntime` ä»‹é¢](http://learn.microsoft.com/dotnet/api/system.management.automation.icommandruntime)é¡åˆ¥ä¾†æ¨¡æ“¬ Cmdlet çš„ PowerShell runtime å¯¦éš›åŸ·è¡Œç’°å¢ƒï¼Œä¸¦å‘¼å«é ç•™çš„ `ProcessInternalForTest()` æ–¹æ³•ä¾†ä¾åºåŸ·è¡Œæ­¤Cmdlet çš„ `BeginProcessing()`,  `ProcessRecord()`,  `EndProcessing()` é€™ä¸‰å€‹ API å¯¦ä½œã€‚
