---
title: PowerShell TDD èµ·æ­¥èµ°

author: è€é®‘ä¼¯
format:
    revealjs:
        width: 1200
        height: 900
        slide-tone: false
        theme: simple
        menu:
            side: right
        include-in-header: 
            text: |
                <style>
                .center-xy {
                margin: 0;
                position: absolute;
                top: 50%;
                left: 50%;
                -ms-transform: translateY(-50%), translateX(-50%);
                transform: translateY(-50%), translateX(-50%);
                }
                </style>
from: markdown+emoji
code-annotations: below
---

# Agenda

:::: {.columns}
::: {.column width="80%"}

* å¦‚ä½•ç”¨ Visual Studio Code å»ºç½® PowerShell TDDé–‹ç™¼ç’°å¢ƒ
* PowerShell æ¸¬è©¦å·¥å…·æ¡†æ¶ Pesterä»‹ç´¹ã€ç‚ºæ—¢æœ‰ PowerShell scriptåŠ ä¸Šå¯åŸ·è¡Œçš„æ¸¬è©¦æ¡ˆä¾‹
* PowerShell + C# binary cmdlet~~ã€[TBD]ASP.NET Core æ•´åˆ PowerShell Hosting Script çš„ TDD~~ç¯„ä¾‹

:::
::: {.column width="20%"}

<div style="text-align: center">

{{< qrcode https://windperson.github.io/PowerShellTDD_GetStart-slide/#/title-slide width=250 height=250 >}}

Slide URL
</div>

:::
::::

{{< include 01_IDE_Setup/_IDE_Setup.qmd >}}

{{< include 02_Pester_Intro/_Pester_Intro.qmd >}}


## PowerShell + C# binary cmdlet

* PowerShell v6+ & Windows PowerShell 5.1+ éƒ½æ”¯æ´ä½¿ç”¨ C# ä¾†æ’°å¯« binary cmdlet ä¾†æ“´å…… PowerShell çš„åŠŸèƒ½ã€‚
* é€é C# çš„å¼·å‹åˆ¥ã€é«˜æ•ˆèƒ½ã€å¤šåŸ·è¡Œç·’ç­‰ç‰¹æ€§ä¾†æ’°å¯« PowerShell çš„ binary cmdletï¼Œå¯ä»¥æé«˜ PowerShell scriptçš„åŸ·è¡Œæ•ˆèƒ½ã€‚
* ä¸€äº› PowerShell åŸç”Ÿæ²’æœ‰æä¾›çš„åŠŸèƒ½å¯é€é C# ä¾†æ’°å¯« binary cmdlet ä¾†æ“´å…… PowerShell çš„ä½¿ç”¨ç¯„åœã€‚

but... C# binary cmdlet çš„æ¸¬è©¦æ¡ˆä¾‹æ’°å¯«ç›¸å°å›°é›£ğŸ˜µ

## PowerShell C# binary cmdlet çš„ç°¡å–®ç¯„ä¾‹

### ***Demo***

[ç¯„ä¾‹ç¨‹å¼ç¢¼ GitHub](http://github.com/windperson/BinaryPwshModuleDemo)

* ä½¿ç”¨ PowerShell Standard Library Nuget å¥—ä»¶çš„ binary cmdlet å¯åœ¨ Windows PowerShell 5.1+ & PowerShell 7+ ç’°å¢ƒä¸­åŸ·è¡Œã€‚
* ä½¿ç”¨ `System.Management.Automation` Nuget å¥—ä»¶çš„ binary cmdlet åƒ…èƒ½åœ¨ PowerShell Core/7+ ç’°å¢ƒä¸­åŸ·è¡Œã€‚
* ç¹¼æ‰¿ `Cmdlet` é¡åˆ¥ä¾†æ’°å¯« PowerShell Simple function çš„ binary cmdlet å¯¦ä½œã€‚
* ç¹¼æ‰¿ `PSCmdlet` é¡åˆ¥ä¾†æ’°å¯« [PowerShell Advanced function](http://learn.microsoft.com/powershell/module/microsoft.powershell.core/about/about_functions_advanced) çš„ binary cmdlet å¯¦ä½œã€‚
* ä½¿ç”¨ C# xUnitæ¸¬è©¦æ¡†æ¶ä¾†æ’°å¯«ç¹¼æ‰¿ `Cmdlet` çš„æ¸¬è©¦æ¡ˆä¾‹ã€‚

## ***(PowerShell + C# binary cmdlet)*** call gRPC API

### ***Demo***

[ç¯„ä¾‹ç¨‹å¼ç¢¼ GitHub](http://github.com/windperson/BinaryPwshModuleDemo)

* ä½¿ç”¨ [gRPC-web](https://devblogs.microsoft.com/dotnet/grpc-web-experiment/) çš„ C# Client Nuget å¥—ä»¶ä»¥ä¾¿åœ¨ä¸æ”¯æ´ HTTP/2 çš„ Windows PowerShell ç’°å¢ƒä¸­å‘¼å« gRPC æœå‹™ã€‚
   * å¦‚ä½•ç‚º Windows PowerShell çš„ C# binary cmdlet æ’°å¯« Assembly Resolver ä»¥ä¾¿æˆåŠŸè¼‰å…¥ gRPC-Web client Libraryã€‚
* ç¹¼æ‰¿ `PSCmdlet` é¡åˆ¥æ‰€æ’°å¯« [PowerShell Advanced function](http://learn.microsoft.com/powershell/module/microsoft.powershell.core/about/about_functions_advanced) çš„ binary cmdlet å¦‚ä½•ä½¿ç”¨ xUnit æ¸¬è©¦æ¡†æ¶ä¾†æ’°å¯«æ¸¬è©¦æ¡ˆä¾‹ã€‚
* ä½¿ç”¨æ··åˆ PowerShell .psd1 è¨­å®šæª” + C# binary cmdlet çš„æ–¹å¼ä¾†æ’°å¯«æ··åˆå‹ PowerShell Module å°ˆæ¡ˆã€‚
    * å¦‚ä½•åœ¨ PowerShell 7+ ç’°å¢ƒä¸­åŸ·è¡Œã€‚
    * å¦‚ä½•é‡å° PowerShell + C# ç¨‹å¼ç¢¼çš„å°ˆæ¡ˆæ’°å¯« PowerShell çš„ Pester æ¸¬è©¦æ¡ˆä¾‹ã€‚

## ***(PowerShell + C# binary cmdlet)*** call gRPC API {.scrollable}

```csharp
#if NETSTANDARD2_0
using System.Management.Automation;
using System.Reflection;

namespace GreeterCmdlet;

public class WindowsPowerShellModuleInitializer : IModuleAssemblyInitializer                                       // <1>
{                                                                                                                  // <1>
    public void OnImport()                                                                                         // <1>
    {                                                                                                              // <1>
        AppDomain.CurrentDomain.AssemblyResolve += DependencyResolution.ResoleAssembly;                            // <1>
    }                                                                                                              // <1>
}                                                                                                                  // <1>

public class WindowsPowerShellModuleCleanup : IModuleAssemblyCleanup                                               // <2>
{                                                                                                                  // <2>
    public void OnRemove(PSModuleInfo psModuleInfo)                                                                // <2>
    {                                                                                                              // <2>
        AppDomain.CurrentDomain.AssemblyResolve -= DependencyResolution.ResoleAssembly;                            // <2>
    }                                                                                                              // <2>
}                                                                                                                  // <2>

internal static class DependencyResolution
{
    private static readonly string ModulePath = Path.GetDirectoryName(Assembly.GetExecutingAssembly().Location)!;

    public static Assembly ResoleAssembly(object? sender, ResolveEventArgs args)
    {
        var assemblyName = new AssemblyName(args.Name);
        if (assemblyName.Name == "System.Buffers")                                                                  // <3>
        {                                                                                                           // <3>
            return Assembly.LoadFrom( Path.Combine(ModulePath, "System.Buffers.dll"));                              // <3>
        }                                                                                                           // <3>
        
        if (assemblyName.Name == "System.Runtime.CompilerServices.Unsafe")                                          // <4>
        {                                                                                                           // <4>
            return Assembly.LoadFrom( Path.Combine(ModulePath, "System.Runtime.CompilerServices.Unsafe.dll"));      // <4>
        }                                                                                                           // <4>

        return null!;
    }
}
#endif
```
1. å¯¦ä½œ `IModuleAssemblyInitializer` ä»‹é¢è¨»å†Š Assembly Resolver äº‹ä»¶è™•ç†å‡½å¼ã€‚
2. å¯¦ä½œ `IModuleAssemblyCleanup` ä»‹é¢ç§»é™¤ Assembly Resolver äº‹ä»¶è™•ç†å‡½å¼ã€‚
3. é‡å° gRPC-Web client nuget ç›¸ä¾çš„ `Systems.Buffers` çš„ Assembly Resolver å¯¦ä½œï¼Œç›´æ¥è¼‰å…¥åŒç›®éŒ„ç”± MSBuild ä¸€èµ· copy éä¾†çš„ dll ç‰ˆæœ¬ã€‚
4. é‡å° `Systems.Buffers` ç›¸ä¾çš„ `System.Runtime.CompilerServices.Unsafe.dll` çš„ Assembly Resolver å¯¦ä½œï¼Œç›´æ¥è¼‰å…¥åŒç›®éŒ„ç”± MSBuild ä¸€èµ· copy éä¾†çš„ dll ç‰ˆæœ¬ã€‚

## [TBD] ASP.NET Core + PowerShell Hosting Script çš„ TDD

### ***Demo***

[ç¯„ä¾‹ç¨‹å¼ç¢¼ GitHub]()

## åƒè€ƒè³‡æ–™

[TBD]

## Q & A {.center-xy}

Any Questions?ğŸ™‹â€â™‚ï¸ğŸ™‹â€â™€ï¸