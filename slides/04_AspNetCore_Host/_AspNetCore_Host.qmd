## ASP.NET Core æ•´åˆ PowerShell Hosting Environment

* ASP.NET Core v3.1+ çš„å°ˆæ¡ˆé€é [`Microsoft.PowerShell.SDK` nuget å¥—ä»¶](http://www.nuget.org/packages/Microsoft.PowerShell.SDK)æ•´åˆ [PowerShell Hosting runtimeç’°å¢ƒ](http://learn.microsoft.com/powershell/scripting/dev-cross-plat/choosing-the-right-nuget-package#microsoftpowershellsdk)ï¼Œä½¿ C# æ‡‰ç”¨ä»¥ [ PowerShell C# API åŸ·è¡Œ PowerShell script æˆ– PowerShell Cmdlet æŒ‡ä»¤](https://learn.microsoft.com/powershell/scripting/developer/hosting/adding-and-invoking-commands)ã€‚


## ASP.NET Core Minimal API æ•´åˆåŸ·è¡Œ PowerShell Script ç¯„ä¾‹

### ***Demo***

[ç¯„ä¾‹ç¨‹å¼ç¢¼ GitHub](http://github.com/windperson/MinimalApiCallPwshDemo)

* æ­¤ç¯„ä¾‹ç¨‹å¼ç‚ºä¸€å€‹æª¢æŸ¥åŸ·è¡Œç’°å¢ƒä¸­å…©å€‹ç›®éŒ„æ˜¯å¦æœ‰åŒæ¨£æª”æ¡ˆçš„ Web APIï¼Œé€é PowerShell script ä¾†åŸ·è¡ŒçœŸæ­£æª”æ¡ˆæ¯”å°çš„å·¥ä½œã€‚
* å¦‚ä½•åœ¨ .NET Core / .NET 5+ å°ˆæ¡ˆä½¿ç”¨ PowerShell Hosting Environment API æŒ‡æ´¾è¼¸å…¥åƒæ•¸çµ¦ PowerShell script åŸ·è¡Œï¼Œä¸¦å–å¾—åŸ·è¡Œçµæœã€‚
* [xUnit](https://xunit.net/) æ¸¬è©¦å°ˆæ¡ˆ test method é–“æ¥åŸ·è¡Œç”¨ Pester æ’°å¯«çš„ PowerShell test case é©—è­‰ script è¡Œç‚ºã€‚

## {.smaller .scrollable}

æ­¤ PowerShell script åœ¨å…ˆå‰çš„ [Pester test case ç¯„ä¾‹å°ˆæ¡ˆä¸­æä¾›](https://github.com/windperson/DemoPester/blob/main/Demo1to1MappingTestModule/Production/ProductFeatures/SysAdminUtil/DuplicateFilesFinder.psm1)ä¸¦ä¸”å·²æœ‰[é©—è­‰è¡Œç‚ºçš„æ¸¬è©¦æ¡ˆä¾‹](https://github.com/windperson/DemoPester/blob/main/Demo1to1MappingTestModule/Production_test/ProductFeatures/SysAdminUtil/DuplicateFilesFinder.Tests.ps1)ã€‚

![]({{< meta part4_img_prefix >}}pics/cli_run_Duplicate_File_Finder.png){height=100% fig-align="center"}

ä½¿ç”¨ PowerShell ä¾†æ’°å¯«å–å¾—æ‰€æœ‰æœ‰ç‰¹å®šå‰¯æª”åçš„æª”æ¡ˆé‚è¼¯ï¼Œæ¯”å–®ç´”ä½¿ç”¨ C# ç°¡å–®:

```PowerShell{.ps1 filename="src\DemoWebApi\PwshScripts\DuplicateFilesFinder.psm1" code-line-numbers="7"}
function Get-Files {
    [SuppressMessage('PSUseSingularNouns', '')]
    param (
        [string]$Path,
        [string]$Extension
    )
    return Get-ChildItem -Path $Path -Recurse -File -Filter "*.$Extension"
}
```

ä¹Ÿå¯ç”¨PowerShell çš„ [`Get-FileHash` Cmdlet](http://learn.microsoft.com/powershell/module/microsoft.powershell.utility/get-filehash) å–å¾—æª”æ¡ˆçš„ Hash å€¼ä¾†å¿«é€Ÿåˆ¤æ–·æª”æ¡ˆå…§å®¹æ˜¯å¦ç›¸åŒ:

```PowerShell{.ps1 filename="src\DemoWebApi\PwshScripts\DuplicateFilesFinder.psm1" code-line-numbers="8"}
function Get-FileContentHash {
    [SuppressMessage('PSAvoidUsingBrokenHashAlgorithms', '', 
        Justification = 'MD5 is just used for file hash comparison')]
    param (
        [Parameter(Mandatory = $true)]
        [System.IO.FileInfo]$FilePath
    )
    return Get-FileHash -Algorithm MD5 -Path $FilePath # -SilentlyContinue
}
```

## {.smaller .scrollable}

åœ¨ ASP.NET Core Minimal API ä¸­ä½¿ç”¨ PowerShell Hosting Environment ä¾†åŸ·è¡Œ PowerShell script/æŒ‡ä»¤ï¼Œéœ€è¦å…ˆå»ºç«‹ç›¸é—œçš„ [PowerShell](http://learn.microsoft.com/dotnet/api/system.management.automation.powershell), [Runspace](http://learn.microsoft.com/dotnet/api/system.management.automation.runspaces.runspace) ç­‰ API ç‰©ä»¶ï¼Œä»¥åŠä½¿ç”¨ `.AddScript()`/`.AddCommand()`/`.AddParameter()` ç­‰ chainable fluent API çš„æ–¹å¼ä¾†è¨­å®š PowerShell script çš„åŸ·è¡Œç’°å¢ƒ:

```csharp{.cs filename="src\DemoWebApi\Services\DuplicateFileFinderInvokeService.cs" code-line-numbers="false"}
public DuplicateFileFinderInvokeService(ILogger<DuplicateFileFinderInvokeService> logger)
{
    _runspacePool = RunspaceFactory.CreateRunspacePool();                                 // <1>
    _runspacePool.Open();                                                                 // <1>
    _logger = logger;
}

public async Task<IList<DuplicateFileResult>> RunScriptAsync(ApiInputDto funcInput,
    CancellationToken cancellationToken)
{
    using var ps = PowerShell.Create();
    ps.RunspacePool = _runspacePool;
    cancellationToken.Register(() =>
    {
        if (ps.InvocationStateInfo.State == PSInvocationState.Running)                   // <2>
        {                                                                                // <2> 
            ps.Stop();                                                                   // <2> 
        }                                                                                // <2>
    });

    /* ... */

    try
    {
        ps.AddScript("Import-Module ./PwshScripts/DuplicateFilesFinder.psm1 -Verbose")   // <3>
            .AddStatement();                                                             // <3>
        ps.AddCommand("Get-DuplicateFile")                                               // <3>
            .AddParameter("SourcePath", funcInput.SourceFolder)                          // <3>
            .AddParameter("ComparePath", funcInput.CompareFolder);                       // <3>
        if (!string.IsNullOrEmpty(funcInput.CompareType))                                // <3>
        {                                                                                // <3>    
            ps.AddParameter("CompareType", funcInput.CompareType);                       // <3>
        }                                                                                // <3>
        /* run above arranged commands via ps.Invoke(...) or ps.InvokeAsync(...) */
    }
    catch (Exception ex)
    {
        // handle exception
    }
}
```
1. ä½¿ç”¨ [`RunspacePool`](http://learn.microsoft.com/dotnet/api/system.management.automation.runspaces.runspacepool) ä¾†ç®¡ç† [PowerShell çš„ Runspace åŸ·è¡Œç’°å¢ƒ](http://learn.microsoft.com/powershell/scripting/developer/hosting/creating-runspaces)ï¼Œè¨˜å¾—è¦å‘¼å« [`.Open()`](https://learn.microsoft.com/en-us/dotnet/api/system.management.automation.runspaces.runspace.open?view=powershellsdk-7.4.0) å¾Œæ‰èƒ½å¾ŒçºŒåœ¨ PowerShell ç‰©ä»¶ä¸ŠåŸ·è¡Œ [`.Invoke()`](http://learn.microsoft.com/dotnet/api/system.management.automation.powershell.invoke)/[`.InvokeAsync()`](http://learn.microsoft.com/dotnet/api/system.management.automation.powershell.invokeasync) å¯¦éš›è·‘ PowerShell ç¨‹å¼ã€‚
2. è¨­å®šç•¶ CancellationToken è§¸ç™¼æ™‚ï¼Œåœæ­¢ç›®å‰ PowerShell runtime çš„åŸ·è¡Œã€‚
3. [`.AddScript()`](http://learn.microsoft.com/dotnet/api/system.management.automation.powershell.addscript) ç”¨ä¾†è¼‰å…¥ PowerShell script æª”æ¡ˆï¼Œ[`.AddStatement()`](http://learn.microsoft.com/dotnet/api/system.management.automation.powershell.addstatement)åŒç­‰æ–¼ PowerShell script æª”æ¡ˆè£¡æ›è¡Œï¼Œ[`.AddCommand()`](http://learn.microsoft.com/dotnet/api/system.management.automation.powershell.addcommand) è¡¨ç¤ºåŸ·è¡Œ PowerShell function/Cmdletï¼Œ[`.AddParameter()`](http://learn.microsoft.com/dotnet/api/system.management.automation.powershell.addcommand)/[`.AddParameters()`](http://learn.microsoft.com/dotnet/api/system.management.automation.powershell.addparameters) ç”¨ä¾†è¨­å®šå‰é¢é è¨ˆè¦åŸ·è¡Œçš„ PowerShell function/Cmdlet çš„è¼¸å…¥åƒæ•¸å€¼ã€‚


## {.smaller .scrollable}

åŸæœ¬åœ¨ PowrShell script è£¡ç”¨çš„æ˜¯ [PowerShell å®šç¾©è‡ªè¨‚ Class é¡åˆ¥](http://learn.microsoft.com/powershell/module/microsoft.powershell.core/about/about_classes)ï¼Œå› æ­¤åœ¨åŸ·è¡Œå®Œç•¢å›å‚³çš„çµæœå€¼ç‰©ä»¶ç›´æ¥ä½¿ç”¨ [**`dynamic`** keyword](https://learn.microsoft.com/dotnet/csharp/advanced-topics/interop/using-type-dynamic) å¯«æ³•ç°¡åŒ–å–å¾— FilePath1 & FilePath2 å±¬æ€§å€¼ç¨‹å¼ç¢¼ã€‚

```csharp{.cs filename="src\DemoWebApi\Services\DuplicateFileFinderInvokeService.cs" code-line-numbers="false"}
var result =
    ps.Invoke(input: null, settings: psInvocationSettings)
        .FirstOrDefault()?.BaseObject as object[];                        // <1>

var duplicateFileResults = new List<DuplicateFileResult>(result.Length);
// use dynamic to make simpler coding style to avoid reflection
foreach (dynamic duplicateFileInfo in result)                             // <2>
{
    var duplicateFileResult = new DuplicateFileResult
    {
        SourceFilePath = duplicateFileInfo.FilePath1.ToString(),          // <3>
        CompareFilePath = duplicateFileInfo.FilePath2.ToString()          // <3>
    };
    duplicateFileResults.Add(duplicateFileResult);
}

return duplicateFileResults;
```
1. ç”±æ–¼åŸæœ¬ PowerShell script function çš„å›å‚³å€¼æ˜¯å–®å€‹ç‰©ä»¶é™£åˆ—ï¼Œæ‰€ä»¥å–å¾—å›å‚³å€¼é †ä¾¿å…ˆè½‰å‹æˆ `object[]` é™£åˆ—ã€‚
2. ä½¿ç”¨ `dynamic` é—œéµå­—ä¾†ç°¡åŒ–åŸæœ¬ PowerShell ç¨‹å¼ç¢¼ä¸­å®šç¾©çš„è‡ªè¨‚ class å‹åˆ¥ã€‚
3. å°±å¯ä»¥ç›´æ¥ä½¿ç”¨ç‰©ä»¶çš„å±¬æ€§å€¼ï¼ˆC#ç·¨è­¯å™¨ä¸æª¢æŸ¥ï¼Œå¦‚æœå¯«éŒ¯å°±æœƒæœ‰ runtime exceptionï¼‰ã€‚

![]({{< meta part4_img_prefix >}}pics/pwsh_defined_class_return_object.png){height=100% fig-align="center"}

## åŸ·è¡Œ Pester æ¸¬è©¦çš„ xUnit ç¨‹å¼ç¢¼ {.smaller .scrollable}

åœ¨ xUnit Test method ä¸­å‘¼å« PowerShell runtime åŸ·è¡Œ Pester æ¸¬è©¦æ¡ˆä¾‹ï¼Œä½¿ç”¨ Pester æ¡†æ¶æä¾›çš„ [`Invoke-Pester` Cmdlet çš„ **`-PassThru`** å‘½ä»¤åˆ—åƒæ•¸](https://pester.dev/docs/commands/Invoke-Pester#-passthru)ï¼Œå¯ä½¿ Pester å°‡åŸ·è¡Œæ¸¬è©¦çµæœå‚³å‡ºï¼Œå†æ–¼ C# ä¸­é©—è­‰æ¸¬è©¦çµæœæ˜¯å¦ç¬¦åˆé æœŸ:

```csharp{.cs filename="tests\DemoWebApi.Tests\PwshModuleTest.cs" code-line-numbers="false"}
[Fact]
public void TestDuplicateFileFinderPwshFunction()
{
    // Arrange
    using var runspace = RunspaceFactory.CreateRunspace();
    runspace.Open();
    using var ps = PowerShell.Create(runspace);
    var psInvocationSettings = new PSInvocationSettings
    {
        AddToHistory = false,
        ErrorActionPreference = ActionPreference.Stop,
    };
    #region TestScript
    const string testScript = 
    """
    $tempModulePath = $env:TEMP + "\PwshModule$((Get-Date).Ticks)"                            // <1>
    if(-not (Test-Path $tempModulePath)) {                                                    // <1>
        New-Item -Path $tempModulePath -ItemType Directory -ErrorAction Stop | Out-Null       // <1>
    }                                                                                         // <1>
    else {                                                                                    // <1>
        Remove-Item -Path $tempModulePath -Recurse -Force -ErrorAction Stop | Out-Null        // <1>
        New-Item -Path $tempModulePath -ItemType Directory -ErrorAction Stop | Out-Null       // <1>
    }                                                                                         // <1>
    Save-Module -Name Pester -Path $tempModulePath -ErrorAction Stop                          // <2>
    Import-Module $tempModulePath\Pester -Force -ErrorAction Stop                             // <2>

    $currentDir = [System.IO.Directory]::GetCurrentDirectory()                                // <3>
    $TestScriptPath = "$currentDir\..\..\..\PwshScripts\DuplicateFilesFinder.Tests.ps1"       // <3>
    if(-not (Test-Path $TestScriptPath)) {                                                    // <3>
        throw "Test script not found at $TestScriptPath"                                      // <3>
    }                                                                                         // <3>
    $result = Invoke-Pester -Path $TestScriptPath -PassThru                                   // <4>
    return $result                                                                            // <4>
    """;
    #endregion
    ps.AddScript(testScript);

    // Act
    var psResult = ps.Invoke(input: null, settings: psInvocationSettings).FirstOrDefault();

    // Assert
    Assert.NotNull(psResult);
    var testResult = psResult.Properties["Result"].Value as string;                           // <5>
    var totalCount = psResult.Properties["TotalCount"].Value as int?;                         // <5>
    var passedCount = psResult.Properties["PassedCount"].Value as int?;                       // <5>
    var failedCount = psResult.Properties["FailedCount"].Value as int?;                       // <5>
    Assert.NotNull(testResult);
    Assert.NotNull(totalCount);
    Assert.NotNull(passedCount);
    Assert.NotNull(failedCount);
    Assert.Equal("Passed", testResult);
    Assert.True(passedCount > 0);
    Assert.Equal(totalCount, passedCount);
    Assert.Equal(0, failedCount);
}
```
1. å»ºç«‹æš«å­˜ç›®éŒ„ä¾†åœ¨ç¨å¾Œæ­¥é©Ÿç”¨ä¾†æ”¾æœ€æ–°ç‰ˆ Pester PowerShell moduleã€‚
2. ä½¿ç”¨ PowerShellGet çš„ `Save-Module` å‘½ä»¤å°‡æœ€æ–°ç‰ˆ Pester å¾ PowerShell Gallery ä¸‹è¼‰è‡³æš«å­˜ç›®éŒ„ï¼Œç„¶å¾Œç”¨ `Import-Module` è¼‰å…¥è©²ç‰ˆæœ¬çš„ Pester æ¨¡çµ„ã€‚(åƒè€ƒ[å®˜æ–¹æ‰‹å‹•å®‰è£èªªæ˜æ–‡ä»¶](https://pester.dev/docs/introduction/installation#installing-manually))
3. å–å¾—ç›®å‰åŸ·è¡Œæ¸¬è©¦ç¨‹å¼çš„ç›®éŒ„ï¼Œä¸¦ä¸”è¨­å®šè¦åŸ·è¡Œçš„ Pester æ¸¬è©¦æ¡ˆä¾‹ script æª”æ¡ˆè·¯å¾‘ã€‚
4. åŸ·è¡Œ Pester æ¸¬è©¦æ¡ˆä¾‹ script æª”æ¡ˆï¼Œä¸¦å°‡æ¸¬è©¦çµæœå›å‚³çµ¦ C# ç¨‹å¼ç¢¼ã€‚
5. ç”±æ–¼ Pester æ¸¬è©¦çµæœå›å‚³çš„æ˜¯ PowerShell [PSCustomObject](http://learn.microsoft.com/powershell/scripting/learn/deep-dives/everything-about-pscustomobject) å‹æ…‹ç‰©ä»¶ï¼Œæ‰€ä»¥é€é `Properties` å±¬æ€§ä¾†å–å¾—å„å€‹æ¸¬è©¦çµæœçš„å±¬æ€§å€¼ã€‚

![]({{< meta part4_img_prefix >}}pics/Invoke-Pester_test_result_object.png){height=100% fig-align="center"}

å¦‚æ­¤æˆ‘å€‘å°±å¯ä»¥å°‡ PowerShell çš„ Pester å–®å…ƒæ¸¬è©¦æ•´åˆè‡³ xUnit æ¸¬è©¦å°ˆæ¡ˆä¸­ï¼Œè®“ Cï¼ƒ code & PowerShell script ä¸€èµ·åŸ·è¡Œæ¸¬è©¦é©—è­‰ç¨‹å¼é‚è¼¯ã€‚ğŸ‘
