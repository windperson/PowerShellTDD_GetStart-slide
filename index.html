<!DOCTYPE html>
<html lang="en"><head>
<script src="index_files/libs/clipboard/clipboard.min.js"></script>
<script src="index_files/libs/quarto-html/tabby.min.js"></script>
<script src="index_files/libs/quarto-html/popper.min.js"></script>
<script src="index_files/libs/quarto-html/tippy.umd.min.js"></script>
<link href="index_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="index_files/libs/quarto-html/light-border.css" rel="stylesheet">
<link href="index_files/libs/quarto-html/quarto-syntax-highlighting-e26003cea8cd680ca0c55a263523d882.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="index_files/libs/quarto-contrib/qrcodejs-v1.0.0/qrcode.js"></script><meta charset="utf-8">
  <meta name="generator" content="quarto-1.6.39">

  <meta name="author" content="老鮑伯">
  <title>PowerShell TDD 起步走</title>
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, minimal-ui">
  <link rel="stylesheet" href="index_files/libs/revealjs/dist/reset.css">
  <link rel="stylesheet" href="index_files/libs/revealjs/dist/reveal.css">
  <style>
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    div.columns{display: flex; gap: min(4vw, 1.5em);}
    div.column{flex: auto; overflow-x: auto;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    ul.task-list{list-style: none;}
    ul.task-list li input[type="checkbox"] {
      width: 0.8em;
      margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
      vertical-align: middle;
    }
    /* CSS for syntax highlighting */
    pre > code.sourceCode { white-space: pre; position: relative; }
    pre > code.sourceCode > span { line-height: 1.25; }
    pre > code.sourceCode > span:empty { height: 1.2em; }
    .sourceCode { overflow: visible; }
    code.sourceCode > span { color: inherit; text-decoration: inherit; }
    div.sourceCode { margin: 1em 0; }
    pre.sourceCode { margin: 0; }
    @media screen {
    div.sourceCode { overflow: auto; }
    }
    @media print {
    pre > code.sourceCode { white-space: pre-wrap; }
    pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
    }
    pre.numberSource code
      { counter-reset: source-line 0; }
    pre.numberSource code > span
      { position: relative; left: -4em; counter-increment: source-line; }
    pre.numberSource code > span > a:first-child::before
      { content: counter(source-line);
        position: relative; left: -1em; text-align: right; vertical-align: baseline;
        border: none; display: inline-block;
        -webkit-touch-callout: none; -webkit-user-select: none;
        -khtml-user-select: none; -moz-user-select: none;
        -ms-user-select: none; user-select: none;
        padding: 0 4px; width: 4em;
        color: #aaaaaa;
      }
    pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
    div.sourceCode
      { color: #003b4f; background-color: #f1f3f5; }
    @media screen {
    pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
    }
    code span { color: #003b4f; } /* Normal */
    code span.al { color: #ad0000; } /* Alert */
    code span.an { color: #5e5e5e; } /* Annotation */
    code span.at { color: #657422; } /* Attribute */
    code span.bn { color: #ad0000; } /* BaseN */
    code span.bu { } /* BuiltIn */
    code span.cf { color: #003b4f; font-weight: bold; } /* ControlFlow */
    code span.ch { color: #20794d; } /* Char */
    code span.cn { color: #8f5902; } /* Constant */
    code span.co { color: #5e5e5e; } /* Comment */
    code span.cv { color: #5e5e5e; font-style: italic; } /* CommentVar */
    code span.do { color: #5e5e5e; font-style: italic; } /* Documentation */
    code span.dt { color: #ad0000; } /* DataType */
    code span.dv { color: #ad0000; } /* DecVal */
    code span.er { color: #ad0000; } /* Error */
    code span.ex { } /* Extension */
    code span.fl { color: #ad0000; } /* Float */
    code span.fu { color: #4758ab; } /* Function */
    code span.im { color: #00769e; } /* Import */
    code span.in { color: #5e5e5e; } /* Information */
    code span.kw { color: #003b4f; font-weight: bold; } /* Keyword */
    code span.op { color: #5e5e5e; } /* Operator */
    code span.ot { color: #003b4f; } /* Other */
    code span.pp { color: #ad0000; } /* Preprocessor */
    code span.sc { color: #5e5e5e; } /* SpecialChar */
    code span.ss { color: #20794d; } /* SpecialString */
    code span.st { color: #20794d; } /* String */
    code span.va { color: #111111; } /* Variable */
    code span.vs { color: #20794d; } /* VerbatimString */
    code span.wa { color: #5e5e5e; font-style: italic; } /* Warning */
  </style>
  <link rel="stylesheet" href="index_files/libs/revealjs/dist/theme/quarto-423d414d36ce366a9d05f36d06304417.css">
  <link href="index_files/libs/revealjs/plugin/quarto-line-highlight/line-highlight.css" rel="stylesheet">
  <link href="index_files/libs/revealjs/plugin/reveal-menu/menu.css" rel="stylesheet">
  <link href="index_files/libs/revealjs/plugin/reveal-menu/quarto-menu.css" rel="stylesheet">
  <link href="index_files/libs/revealjs/plugin/quarto-support/footer.css" rel="stylesheet">
  <style type="text/css">
    .reveal div.sourceCode {
      margin: 0;
      overflow: auto;
    }
    .reveal div.hanging-indent {
      margin-left: 1em;
      text-indent: -1em;
    }
    .reveal .slide:not(.center) {
      height: 100%;
    }
    .reveal .slide.scrollable {
      overflow-y: auto;
    }
    .reveal .footnotes {
      height: 100%;
      overflow-y: auto;
    }
    .reveal .slide .absolute {
      position: absolute;
      display: block;
    }
    .reveal .footnotes ol {
      counter-reset: ol;
      list-style-type: none; 
      margin-left: 0;
    }
    .reveal .footnotes ol li:before {
      counter-increment: ol;
      content: counter(ol) ". "; 
    }
    .reveal .footnotes ol li > p:first-child {
      display: inline-block;
    }
    .reveal .slide ul,
    .reveal .slide ol {
      margin-bottom: 0.5em;
    }
    .reveal .slide ul li,
    .reveal .slide ol li {
      margin-top: 0.4em;
      margin-bottom: 0.2em;
    }
    .reveal .slide ul[role="tablist"] li {
      margin-bottom: 0;
    }
    .reveal .slide ul li > *:first-child,
    .reveal .slide ol li > *:first-child {
      margin-block-start: 0;
    }
    .reveal .slide ul li > *:last-child,
    .reveal .slide ol li > *:last-child {
      margin-block-end: 0;
    }
    .reveal .slide .columns:nth-child(3) {
      margin-block-start: 0.8em;
    }
    .reveal blockquote {
      box-shadow: none;
    }
    .reveal .tippy-content>* {
      margin-top: 0.2em;
      margin-bottom: 0.7em;
    }
    .reveal .tippy-content>*:last-child {
      margin-bottom: 0.2em;
    }
    .reveal .slide > img.stretch.quarto-figure-center,
    .reveal .slide > img.r-stretch.quarto-figure-center {
      display: block;
      margin-left: auto;
      margin-right: auto; 
    }
    .reveal .slide > img.stretch.quarto-figure-left,
    .reveal .slide > img.r-stretch.quarto-figure-left  {
      display: block;
      margin-left: 0;
      margin-right: auto; 
    }
    .reveal .slide > img.stretch.quarto-figure-right,
    .reveal .slide > img.r-stretch.quarto-figure-right  {
      display: block;
      margin-left: auto;
      margin-right: 0; 
    }
  </style>
  <style>
  .center-xy {
  margin: 0;
  position: absolute;
  top: 50%;
  left: 50%;
  -ms-transform: translateY(-50%), translateX(-50%);
  transform: translateY(-50%), translateX(-50%);
  }
  </style>
</head>
<body class="quarto-light">
  <div class="reveal">
    <div class="slides">

<section id="title-slide" class="quarto-title-block center">
  <h1 class="title">PowerShell TDD 起步走</h1>

<div class="quarto-title-authors">
<div class="quarto-title-author">
<div class="quarto-title-author-name">
老鮑伯 
</div>
</div>
</div>

</section>
<section id="agenda" class="title-slide slide level1 center">
<h1>Agenda</h1>
<div class="columns">
<div class="column" style="width:80%;">
<ul>
<li>Visual Studio Code 建置 PowerShell TDD 開發環境</li>
<li>PowerShell 測試工具框架 Pester介紹、為既有 PowerShell script加上可執行的測試案例</li>
<li>PowerShell + C# binary cmdlet、ASP.NET Core 整合 PowerShell Hosting Script 的 TDD 範例</li>
</ul>
</div><div class="column" style="width:20%;">
<div style="text-align: center">
<div id="" class="qrcode"></div>
<script type="text/javascript">
(function() {
  var script = document.currentScript;
  var qrcode = script.previousElementSibling;
  qrcode.qrcode = new QRCode(qrcode, {"colorDark":"#000000","colorLight":"#ffffff","height":"250","text":"https://windperson.github.io/PowerShellTDD_GetStart-slide/#/title-slide","width":"250"});
  script.remove();
})();
</script>
    
<p>Slide URL</p>
</div>
</div></div>
</section>

<section>
<section id="visual-studio-code-建置-powershell-tdd-開發環境" class="title-slide slide level1 center">
<h1>Visual Studio Code 建置 PowerShell TDD 開發環境</h1>

</section>
<section id="vscode-as-powershell-tdd-ide" class="slide level2">
<h2>VSCode as PowerShell TDD IDE</h2>
<ul>
<li>建議使用 <a href="http://code.visualstudio.com"><strong>VSCode</strong>(Visual Studio Code)</a> 安裝官方 <a href="http://github.com/PowerShell/vscode-powershell">PowerShell Extension</a> + C# 相關開發擴充套件 作為 PowerShell 開發環境:
<ul>
<li>官方安裝設定教學： <br>
<ul>
<li><a href="https://code.visualstudio.com/docs/languages/powershell" class="uri">https://code.visualstudio.com/docs/languages/powershell</a></li>
<li><a href="https://learn.microsoft.com/powershell/scripting/dev-cross-plat/vscode/using-vscode" class="uri">https://learn.microsoft.com/powershell/scripting/dev-cross-plat/vscode/using-vscode</a></li>
</ul></li>
<li>提供 PowerShell 的 Syntax Highlighting、Outline View、Go to Definition、IntelliSense、Code Lens、Run &amp; Debug Pester test code 等功能。</li>
<li>可 debug PowerShell + C# binary cmdlet 的混合專案。</li>
</ul></li>
</ul>
</section>
<section id="vscode-as-powershell-tdd-ide-1" class="slide level2 scrollable">
<h2>VSCode as PowerShell TDD IDE</h2>
<ul>
<li><p>為了有一個乾淨＆快速的TDD開發環境，建議使用<a href="http://code.visualstudio.com/docs/editor/portable">Portable 版本的 VSCode</a>，以免同時安裝太多擴充套件消耗資源。 <img data-src="./01_IDE_Setup/pics/vscode_zip_version.png" class="quarto-figure quarto-figure-center"></p></li>
<li><p>一定要安裝的套件其實只有三個(去掉 Vim 😆)：<br> (<a href="https://marketplace.visualstudio.com/items?itemName=ms-dotnettools.csdevkit">C# Dev Kit</a>套件非免費且無法在封閉內網環境使用) <img data-src="./01_IDE_Setup/pics/minimal_powershell_dev_extensions.png" class="quarto-figure quarto-figure-center"></p></li>
</ul>
</section>
<section id="example-vscode-environment" class="slide level2">
<h2>Example VSCode Environment</h2>
<p>由於 .NET SDK 會根據作業系統＆CPU架構不同而有不同的安裝方式，提供以下版本的 Portable VSCode + PowerShell Extension + C# 相關開發擴充套件 的範例開發環境：</p>
<ul>
<li><a href="https://github.com/windperson/vscode_win32x64_pwsh">Windows 10 &amp; 11 (x64)</a></li>
<li><a href="https://github.com/windperson/vscode_win32Arm64_pwsh">Windows 11 (ARM64)</a></li>
<li><a href="">macOS (ARM 64)</a></li>
</ul>
</section>
<section id="example-vscode-environment---windowsx64" class="slide level2 scrollable">
<h2>Example VSCode Environment - Windows(x64)</h2>
<p>除了要手動開啟Windows『開發者模式』設定以及將同捆的 .NET SDK 的執行檔路徑到環境變數之外，其他的都是使用 Portable 版本的開發環境：</p>
<ul>
<li>Windows 環境的 relative symbolic link 需要啟用開發者模式才能讓 PowerShell 以不需管理員權限的方式設定。 <img data-src="./01_IDE_Setup/pics/win10_developer_mode.png" class="quarto-figure quarto-figure-center"><br>
否則甚至連Windows內建的解壓縮功能都會被拒絕存取。 <img data-src="./01_IDE_Setup/pics/symbolic_link_no_permission.png" class="quarto-figure quarto-figure-center"></li>
<li>.NET SDK 的執行路徑建議以 <strong>DOTNET_ROOT</strong> 環境變數設定，以便於切換不同版本的 dotnet 指令<br>（使用系統安裝的 .NET SDK 8.0 也👌🆗）。 <img data-src="./01_IDE_Setup/pics/set_dotnet_root_env-Windows_x64.png" class="quarto-figure quarto-figure-center"> <img data-src="./01_IDE_Setup/pics/set_path_env_include_dotnet_root-Windows_x64.png" class="quarto-figure quarto-figure-center"></li>
</ul>
</section>
<section id="example-vscode-environment---windowsx64-1" class="slide level2 scrollable">
<h2>Example VSCode Environment - Windows(x64)</h2>
<p>開發環境的檔案目錄架構:</p>
<div class="quarto-figure quarto-figure-center">
<figure>
<p><img data-src="./01_IDE_Setup/pics/portable_vscode_ide_files.png" class="quarto-figure quarto-figure-center" style="width:80.0%;height:80.0%"></p>
</figure>
</div>
<ul>
<li><p>使用獨立的 PowerShell Module 目錄避免因為不同專案需要的各種版本 PowerShell Module 互衝，或是和系統層級的 Module 混淆。</p></li>
<li><p>因此要在 PowerShell Module 目錄內下載並安裝 <a href="https://github.com/JustinGrote/ModuleFast">“ModuleFast”</a> 這個工具型 PowerShell Module，用此命令列工具安裝 PowerShell Module 時可下指令指定安裝來源、安裝位置、模組版本。</p></li>
</ul>
<p>例如以下範例，從 nuget.org 安裝 Pester v5.6.1 版本到 D:_portable_modules 目錄：</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode numberSource powershell number-lines code-with-copy"><code class="sourceCode powershell"><span id="cb1-1"><a href=""></a> @<span class="op">{</span>ModuleName<span class="op">=</span><span class="st">'Pester'</span><span class="op">;</span>ModuleVersion<span class="op">=</span><span class="st">'5.6.1'</span><span class="op">}</span> <span class="op">|</span> Install-ModuleFast <span class="op">-</span>Source api<span class="op">.</span><span class="fu">nuget</span><span class="op">.</span><span class="fu">org</span><span class="op">/</span>v3 <span class="op">-</span>Destination D<span class="op">:</span>\vscode_portable\pwsh_modules</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><br> 另外還有一個好用的開發用 PowerShell 指令列工具模組 <a href="http://github.com/deadlydog/PowerShell.dumPS">PowerShell.dumPS</a>，可以用來在 VSCode 中斷點除錯時，使用 Debug Console 快速查看 PowerShell 物件的類別、屬性值資訊。</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode numberSource powershell number-lines code-with-copy"><code class="sourceCode powershell"><span id="cb2-1"><a href=""></a><span class="va">$AnyObject</span> <span class="op">|</span> Out-Dump</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="quarto-figure quarto-figure-center">
<figure>
<p><img data-src="./01_IDE_Setup/pics/demo_PowerShell.dumPS.png" class="quarto-figure quarto-figure-center"></p>
</figure>
</div>
</section>
<section id="example-vscode-environment---windowsx64-2" class="slide level2 scrollable">
<h2>Example VSCode Environment - Windows(x64)</h2>
<p>在 pwsh-scripts 目錄的開發環境設定用 script 檔案：</p>
<ul>
<li><p><strong>PSScriptAnalyzerSettings.psd1</strong><br>用來控制 VSCode 官方 PowerShell Extension 內建的 <a href="https://learn.microsoft.com/powershell/utility-modules/psscriptanalyzer/using-scriptanalyze">PSScriptAnalyzer(PowerShell Syntax Linter)</a> 設定檔。</p></li>
<li><p><strong>Set-PwshTools.ps1</strong><br>替代 PowerShell Profile 的設定檔，用來設定 VSCode 整合終端機中 PowerShell 命令列的自動完成功能相關設定以及添加一些類似 Unix 環境的檔案命令。</p>
<div class="sourceCode" id="annotated-cell-7"><pre class="sourceCode numberSource json code-annotation-code number-lines code-with-copy code-annotated"><code class="sourceCode json"><span id="annotated-cell-7-1"><a href="#annotated-cell-7-1"></a>  <span class="er">"terminal.integrated.profiles.windows":</span> <span class="fu">{</span></span>
<span id="annotated-cell-7-2"><a href="#annotated-cell-7-2"></a>    <span class="dt">"PowerShell"</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="annotated-cell-7-3"><a href="#annotated-cell-7-3"></a>      <span class="dt">"title"</span><span class="fu">:</span> <span class="st">"Bundled pwsh"</span><span class="fu">,</span></span>
<span id="annotated-cell-7-4"><a href="#annotated-cell-7-4"></a>      <span class="dt">"path"</span><span class="fu">:</span> <span class="st">"D:</span><span class="ch">\\</span><span class="st">vscode_portable</span><span class="ch">\\</span><span class="st">PowerShell-x64</span><span class="ch">\\</span><span class="st">pwsh.exe"</span><span class="fu">,</span></span>
<span id="annotated-cell-7-5"><a href="#annotated-cell-7-5"></a>      <span class="dt">"args"</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="annotated-cell-7-6"><a href="#annotated-cell-7-6"></a>        <span class="st">"-nol"</span><span class="ot">,</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-7" data-target-annotation="1" onclick="event.preventDefault();" href="">1</a><span id="annotated-cell-7-7" class="code-annotation-target"><a href="#annotated-cell-7-7"></a>        <span class="st">"-nop"</span><span class="ot">,</span></span>
<span id="annotated-cell-7-8"><a href="#annotated-cell-7-8"></a>        <span class="st">"-noe"</span><span class="ot">,</span></span>
<span id="annotated-cell-7-9"><a href="#annotated-cell-7-9"></a>        <span class="st">"-ex"</span><span class="ot">,</span></span>
<span id="annotated-cell-7-10"><a href="#annotated-cell-7-10"></a>        <span class="st">"RemoteSigned"</span><span class="ot">,</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-7" data-target-annotation="2" onclick="event.preventDefault();" href="">2</a><span id="annotated-cell-7-11" class="code-annotation-target"><a href="#annotated-cell-7-11"></a>        <span class="st">"-Command"</span><span class="ot">,</span></span>
<span id="annotated-cell-7-12"><a href="#annotated-cell-7-12"></a>        <span class="st">"Invoke-expression </span><span class="ch">\"</span><span class="st">. D:</span><span class="ch">\\</span><span class="st">vscode_portable</span><span class="ch">\\</span><span class="st">pwsh-scripts</span><span class="ch">\\</span><span class="st">Set-PwshTools.ps1</span><span class="ch">\"</span><span class="st">"</span></span>
<span id="annotated-cell-7-13"><a href="#annotated-cell-7-13"></a>      <span class="ot">]</span></span>
<span id="annotated-cell-7-14"><a href="#annotated-cell-7-14"></a>    <span class="fu">}</span></span>
<span id="annotated-cell-7-15"><a href="#annotated-cell-7-15"></a>  <span class="fu">}</span><span class="er">,</span></span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-7" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-7" data-code-lines="7" data-code-annotation="1">使用 <code>-nop</code> 參數避免執行目前系統/使用者等級的 PowerShell Profile 設定檔</span>
</dd>
<dt data-target-cell="annotated-cell-7" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-7" data-code-lines="11,12" data-code-annotation="2">執行 <code>Invoke-Expression ". D:\vscode_portable\pwsh-scripts\Set-PwshTools.ps1"</code> 來替代。</span>
</dd>
</dl></li>
<li><p><strong>Update-SymLinks.ps1</strong><br>用來更新/恢復兩個 symbolic link 檔案－1. 根目錄的 VSCode 主程式啟動連結 2. VSCode 可攜模式設定的使用者資料檔案目錄連結。<br>(Windows 10 symbolic link 會因搬移到不同磁碟機/電腦而失效) <img data-src="./01_IDE_Setup/pics/update_symbolic_link-Windows_x64.png" class="quarto-figure quarto-figure-center"></p></li>
</ul>
</section></section>
<section>
<section id="powershell-測試工具框架-pester-介紹" class="title-slide slide level1 center">
<h1>PowerShell 測試工具框架 Pester 介紹</h1>

</section>
<section id="pester---powershell-test-framework" class="slide level2">
<h2>Pester - PowerShell Test Framework</h2>
<ul>
<li><a href="http://pester.dev">Pester</a> 是一個 PowerShell 的全家桶測試框架，可以用來撰寫測試案例、執行測試案例、產生測試報告。</li>
<li>提供 <a href="http://pester.dev/docs/assertions/">Assertion Syntax</a> / <a href="http://pester.dev/docs/usage/mocking">Mock</a> / <a href="http://pester.dev/docs/commands/Invoke-Pester">Test Runner</a> / <a href="http://pester.dev/docs/usage/code-coverage">Code Coverage</a> 等進行測試驅動開發時需要的功能。</li>
<li>提供測試用虛擬磁碟 <a href="http://pester.dev/docs/usage/testdrive"><code>TestDrive:</code></a> /<br>虛擬 Windows Registry <a href="http://pester.dev/docs/usage/testregistry"><code>TestRegistry:</code></a> 的執行環境隔離功能，方便進行測試程式碼撰寫。</li>
<li>跟 VSCode PowerShell Extension 整合，可在 <a href="http://pester.dev/docs/usage/vscode">VSCode 的 Code Lens中直接執行/除錯特定的單一 Pester 測試案例</a>。</li>
<li>PowerShell 官方也使用此測試框架來寫測試案例。<br><a href="https://github.com/PowerShell/PowerShell/blob/master/docs/testing-guidelines/WritingPesterTests.md" class="uri">https://github.com/PowerShell/PowerShell/blob/master/docs/testing-guidelines/WritingPesterTests.md</a></li>
</ul>
</section>
<section id="pester-撰寫測試案例程式碼時的重點" class="slide level2 scrollable">
<h2>Pester 撰寫測試案例程式碼時的重點</h2>
<ul>
<li>以 <code>Describe</code> 來描述測試案例的主題，以 <code>Context</code> 來描述測試案例的子主題，以 <code>It</code> 來描述測試案例的斷言(Test Case)。</li>
<li>雖然 Pester 自己預設行為是去搜尋執行目錄下以 <code>.Tests.ps1</code> 檔案名結尾的 PowerShell Script 檔案作為測試案例程式碼執行，但是得自行處理待測試 PowerShell Script 檔案( .ps1/.psm1 )的模組載入問題。</li>
<li>透過 <a href="http://pester.dev/docs/usage/mocking"><code>Mock</code></a> 來模擬外部依賴的PowerShell函式呼叫/原生應用程式執行，以達到隔離測試的目的：
<ul>
<li><code>Mock</code> 會在測試案例執行前將原本的函式/程式替換成 Mock 所定義的行為，測試案例執行完畢後再還原。
<ul>
<li>Pester 的 Mock 功能在 PowerShell v7+ 支援較好，建議測試案例的 script 程式碼儘量用 PowerShell v7+ 的環境來執行。</li>
<li>Pester 底層使用 <a href="http://learn.microsoft.com/powershell/scripting/learn/shell/using-aliases">PowerShell Alias 功能</a>實現 Mock 命令實作。</li>
<li>當宣告 Mock 時，<strong>要蓋掉的 PowerShell Cmdlet/函式命令 必須已存在於待測試程式碼的 Module Scope 內，否則 Pester 會無法蓋掉，轉而拋出執行錯誤。</strong></li>
<li>宣告的 Mock 在使用命令的程式碼所在的 Module <a href="http://learn.microsoft.com/powershell/module/microsoft.powershell.core/about/about_scopes">作用域(Module Scope)</a> 內有效，而非全域有效。</li>
</ul></li>
<li><code>Mock</code> 會記錄 Mock 物件的呼叫次數、參數、回傳值等資訊，方便撰寫測試案例時檢查。</li>
<li><code>Mock</code> 無法蓋掉使用 binary cmdlet 載入的 C# Cmdlet 函式，因為同名模組中的函式呼叫優先順序 <strong><em>C# &gt;&gt;&gt; PowerShell</em></strong>。</li>
</ul></li>
<li>透過 <code>TestDrive:</code> 來建立虛擬磁碟空間，以達到隔離測試的目的。</li>
<li>透過 <code>TestRegistry:</code> 來建立虛擬 Windows Registry 空間，以達到隔離測試的目的。</li>
<li>必要時可建立 Customer Pester Assertion 以便簡化驗證測試結果的程式碼區塊的撰寫。</li>
</ul>
</section>
<section id="pester-為既有程式撰寫測試案例程式碼範例" class="slide level2">
<h2>Pester 為既有程式撰寫測試案例程式碼範例</h2>
<h3 id="demo"><strong><em>Demo</em></strong></h3>
<p><a href="http://github.com/windperson/DemoPester">範例程式碼 GitHub</a></p>
<ul>
<li>系統性的制式 Data-Driven 測試案例架構來驗證各模組函式的輸入參數名稱、型別、回傳值。</li>
<li>由於 PowerShell 對於 .ps1 &amp; .psm1 模組載入機制的不同，會造成某些待測模組的程式碼寫法，會不好撰寫測試程式碼。
<ul>
<li><code>InModuleScope</code> 以便在待測模組載入時的環境變數設定自定義邏輯(塞入固定參數/Mock/Assertion程式碼)。</li>
<li>藉由先宣告一些 Dummy function 來『先佔位』以便順利進行宣告 MOck 語法，然後再載入模組以便進行測試。</li>
</ul></li>
<li>Pester Custom Assertion 的撰寫及註冊使用。</li>
</ul>
</section></section>
<section>
<section id="powershell-c-binary-cmdlet" class="title-slide slide level1 center">
<h1>PowerShell + C# binary cmdlet</h1>

</section>
<section id="powershell-c-binary-cmdlet-1" class="slide level2">
<h2>PowerShell + C# binary cmdlet</h2>
<ul>
<li>PowerShell v6+ &amp; Windows PowerShell 5.1+ 都支援使用 C# 來撰寫 binary cmdlet 來擴充 PowerShell 的功能。</li>
<li>透過 C# 的強型別、高效能、多執行緒等特性來撰寫 PowerShell 的 binary cmdlet，可以提高 PowerShell script的執行效能。</li>
<li>一些 PowerShell 原生沒有提供的功能可透過 C# 來撰寫 binary cmdlet 來擴充 PowerShell 的使用範圍。</li>
</ul>
<p>but… C# binary cmdlet 的測試案例撰寫相對較困難😵</p>
</section>
<section id="powershell-c-binary-cmdlet-的簡單範例" class="slide level2">
<h2>PowerShell C# binary cmdlet 的簡單範例</h2>
<h3 id="demo-1"><strong><em>Demo</em></strong></h3>
<p><a href="http://github.com/windperson/BinaryPwshModuleDemo">範例程式碼 GitHub</a></p>
<ul>
<li>使用 <a href="http://www.nuget.org/packages/PowerShellStandard.Library/"><code>PowerShell.Standard.Library</code> Nuget 套件</a>的 binary cmdlet 可在 Windows PowerShell v5.1+ &amp; PowerShell v7+ 環境中執行。</li>
<li>使用 <a href="http://www.nuget.org/packages/System.Management.Automation/"><code>System.Management.Automation</code> Nuget 套件</a>的 binary cmdlet 僅能在 PowerShell Core/v7+ 環境中執行。</li>
<li>繼承 <code>Cmdlet</code> 類別來撰寫 PowerShell Simple function 的 binary cmdlet 實作。</li>
<li>繼承 <code>PSCmdlet</code> 類別來撰寫 <a href="http://learn.microsoft.com/powershell/module/microsoft.powershell.core/about/about_functions_advanced">PowerShell Advanced function</a> 的 binary cmdlet 實作。</li>
<li>使用 C# xUnit測試框架來撰寫繼承 <code>Cmdlet</code> 的測試案例。</li>
</ul>
</section>
<section id="powershell-c-binary-cmdlet-call-grpc-api" class="slide level2">
<h2><strong><em>(PowerShell + C# binary cmdlet)</em></strong> call gRPC API</h2>
<h3 id="demo-2"><strong><em>Demo</em></strong></h3>
<p><a href="http://github.com/windperson/BinaryPwshModuleDemo">範例程式碼 GitHub</a></p>
<ul>
<li>使用 <a href="https://devblogs.microsoft.com/dotnet/grpc-web-experiment/">gRPC-web</a> 的 C# Client Nuget 套件以便在不支援 HTTP/2 的 Windows PowerShell 環境中呼叫 gRPC 服務。
<ul>
<li>如何為 Windows PowerShell 的 C# binary cmdlet 撰寫 Assembly Resolver 以便成功載入 gRPC-Web client Library。</li>
</ul></li>
<li>繼承 <code>PSCmdlet</code> 類別所撰寫 <a href="http://learn.microsoft.com/powershell/module/microsoft.powershell.core/about/about_functions_advanced">PowerShell Advanced function</a> 的 binary cmdlet 如何使用 xUnit 測試框架來撰寫測試案例。</li>
<li>使用混合 PowerShell .psd1 設定檔 + C# binary cmdlet 的方式來撰寫混合型 PowerShell Module 專案。
<ul>
<li>如何在 Windows PowerShell v5.1 &amp; PowerShell v7+ 環境中執行。</li>
<li>如何針對 PowerShell + C# 程式碼的專案撰寫 PowerShell 的 Pester 測試案例。</li>
</ul></li>
</ul>
</section>
<section id="section" class="slide level2 smaller scrollable">
<h2></h2>
<p>gRPC-Web 的相依 Assembly dll 版本比原本 Windows PowerShell v5.1 所使用的版本新，需要寫額外的 Assembly Resolver 程式碼控制 .NET Framework CLR 載入 dll 機制。</p>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>Pwsh\GreeterCmdlet\WindowsPowerShellModuleInitializer.cs</strong></pre>
</div>
<div class="sourceCode" id="annotated-cell-3" data-filename="Pwsh\GreeterCmdlet\WindowsPowerShellModuleInitializer.cs"><pre class="sourceCode csharp cs code-annotation-code code-with-copy code-annotated"><code class="sourceCode cs"><span id="annotated-cell-3-1"><a href="#annotated-cell-3-1" aria-hidden="true" tabindex="-1"></a><span class="kw">#if</span> NETSTANDARD2_0</span>
<span id="annotated-cell-3-2"><a href="#annotated-cell-3-2" aria-hidden="true" tabindex="-1"></a><span class="kw">using</span> System<span class="op">.</span><span class="fu">Management</span><span class="op">.</span><span class="fu">Automation</span><span class="op">;</span></span>
<span id="annotated-cell-3-3"><a href="#annotated-cell-3-3" aria-hidden="true" tabindex="-1"></a><span class="kw">using</span> System<span class="op">.</span><span class="fu">Reflection</span><span class="op">;</span></span>
<span id="annotated-cell-3-4"><a href="#annotated-cell-3-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-3-5"><a href="#annotated-cell-3-5" aria-hidden="true" tabindex="-1"></a><span class="kw">namespace</span> GreeterCmdlet<span class="op">;</span></span>
<span id="annotated-cell-3-6"><a href="#annotated-cell-3-6" aria-hidden="true" tabindex="-1"></a></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-3" data-target-annotation="1" onclick="event.preventDefault();" href="">1</a><span id="annotated-cell-3-7" class="code-annotation-target"><a href="#annotated-cell-3-7" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> WindowsPowerShellModuleInitializer <span class="op">:</span> IModuleAssemblyInitializer</span>
<span id="annotated-cell-3-8"><a href="#annotated-cell-3-8" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="annotated-cell-3-9"><a href="#annotated-cell-3-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">OnImport</span><span class="op">()</span></span>
<span id="annotated-cell-3-10"><a href="#annotated-cell-3-10" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="annotated-cell-3-11"><a href="#annotated-cell-3-11" aria-hidden="true" tabindex="-1"></a>        AppDomain<span class="op">.</span><span class="fu">CurrentDomain</span><span class="op">.</span><span class="fu">AssemblyResolve</span> <span class="op">+=</span> DependencyResolution<span class="op">.</span><span class="fu">ResoleAssembly</span><span class="op">;</span></span>
<span id="annotated-cell-3-12"><a href="#annotated-cell-3-12" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="annotated-cell-3-13"><a href="#annotated-cell-3-13" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="annotated-cell-3-14"><a href="#annotated-cell-3-14" aria-hidden="true" tabindex="-1"></a></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-3" data-target-annotation="2" onclick="event.preventDefault();" href="">2</a><span id="annotated-cell-3-15" class="code-annotation-target"><a href="#annotated-cell-3-15" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> WindowsPowerShellModuleCleanup <span class="op">:</span> IModuleAssemblyCleanup</span>
<span id="annotated-cell-3-16"><a href="#annotated-cell-3-16" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="annotated-cell-3-17"><a href="#annotated-cell-3-17" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">OnRemove</span><span class="op">(</span>PSModuleInfo psModuleInfo<span class="op">)</span></span>
<span id="annotated-cell-3-18"><a href="#annotated-cell-3-18" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="annotated-cell-3-19"><a href="#annotated-cell-3-19" aria-hidden="true" tabindex="-1"></a>        AppDomain<span class="op">.</span><span class="fu">CurrentDomain</span><span class="op">.</span><span class="fu">AssemblyResolve</span> <span class="op">-=</span> DependencyResolution<span class="op">.</span><span class="fu">ResoleAssembly</span><span class="op">;</span></span>
<span id="annotated-cell-3-20"><a href="#annotated-cell-3-20" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="annotated-cell-3-21"><a href="#annotated-cell-3-21" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="annotated-cell-3-22"><a href="#annotated-cell-3-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-3-23"><a href="#annotated-cell-3-23" aria-hidden="true" tabindex="-1"></a><span class="kw">internal</span> <span class="kw">static</span> <span class="kw">class</span> DependencyResolution</span>
<span id="annotated-cell-3-24"><a href="#annotated-cell-3-24" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="annotated-cell-3-25"><a href="#annotated-cell-3-25" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="kw">static</span> <span class="kw">readonly</span> <span class="dt">string</span> ModulePath <span class="op">=</span> </span>
<span id="annotated-cell-3-26"><a href="#annotated-cell-3-26" aria-hidden="true" tabindex="-1"></a>                                Path<span class="op">.</span><span class="fu">GetDirectoryName</span><span class="op">(</span>Assembly<span class="op">.</span><span class="fu">GetExecutingAssembly</span><span class="op">().</span><span class="fu">Location</span><span class="op">)!;</span></span>
<span id="annotated-cell-3-27"><a href="#annotated-cell-3-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-3-28"><a href="#annotated-cell-3-28" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="kw">static</span> Assembly <span class="fu">ResoleAssembly</span><span class="op">(</span><span class="dt">object</span><span class="op">?</span> sender<span class="op">,</span> ResolveEventArgs args<span class="op">)</span></span>
<span id="annotated-cell-3-29"><a href="#annotated-cell-3-29" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="annotated-cell-3-30"><a href="#annotated-cell-3-30" aria-hidden="true" tabindex="-1"></a>        <span class="dt">var</span> assemblyName <span class="op">=</span> <span class="kw">new</span> <span class="fu">AssemblyName</span><span class="op">(</span>args<span class="op">.</span><span class="fu">Name</span><span class="op">);</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-3" data-target-annotation="3" onclick="event.preventDefault();" href="">3</a><span id="annotated-cell-3-31" class="code-annotation-target"><a href="#annotated-cell-3-31" aria-hidden="true" tabindex="-1"></a>        <span class="kw">if</span> <span class="op">(</span>assemblyName<span class="op">.</span><span class="fu">Name</span> <span class="op">==</span> <span class="st">"System.Buffers"</span><span class="op">)</span></span>
<span id="annotated-cell-3-32"><a href="#annotated-cell-3-32" aria-hidden="true" tabindex="-1"></a>        <span class="op">{</span></span>
<span id="annotated-cell-3-33"><a href="#annotated-cell-3-33" aria-hidden="true" tabindex="-1"></a>            <span class="kw">return</span> Assembly<span class="op">.</span><span class="fu">LoadFrom</span><span class="op">(</span>Path<span class="op">.</span><span class="fu">Combine</span><span class="op">(</span>ModulePath<span class="op">,</span> <span class="st">"System.Buffers.dll"</span><span class="op">));</span></span>
<span id="annotated-cell-3-34"><a href="#annotated-cell-3-34" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="annotated-cell-3-35"><a href="#annotated-cell-3-35" aria-hidden="true" tabindex="-1"></a>        </span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-3" data-target-annotation="4" onclick="event.preventDefault();" href="">4</a><span id="annotated-cell-3-36" class="code-annotation-target"><a href="#annotated-cell-3-36" aria-hidden="true" tabindex="-1"></a>        <span class="kw">if</span> <span class="op">(</span>assemblyName<span class="op">.</span><span class="fu">Name</span> <span class="op">==</span> <span class="st">"System.Runtime.CompilerServices.Unsafe"</span><span class="op">)</span></span>
<span id="annotated-cell-3-37"><a href="#annotated-cell-3-37" aria-hidden="true" tabindex="-1"></a>        <span class="op">{</span></span>
<span id="annotated-cell-3-38"><a href="#annotated-cell-3-38" aria-hidden="true" tabindex="-1"></a>            <span class="kw">return</span> Assembly<span class="op">.</span><span class="fu">LoadFrom</span><span class="op">(</span>Path<span class="op">.</span><span class="fu">Combine</span><span class="op">(</span>ModulePath<span class="op">,</span> <span class="st">"System.Runtime.CompilerServices.Unsafe.dll"</span><span class="op">));</span></span>
<span id="annotated-cell-3-39"><a href="#annotated-cell-3-39" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="annotated-cell-3-40"><a href="#annotated-cell-3-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-3-41"><a href="#annotated-cell-3-41" aria-hidden="true" tabindex="-1"></a>        <span class="kw">return</span> <span class="kw">null</span><span class="op">!;</span></span>
<span id="annotated-cell-3-42"><a href="#annotated-cell-3-42" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="annotated-cell-3-43"><a href="#annotated-cell-3-43" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="annotated-cell-3-44"><a href="#annotated-cell-3-44" aria-hidden="true" tabindex="-1"></a><span class="kw">#endif</span></span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-3" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-3" data-code-lines="7,8,9,10,11,12,13" data-code-annotation="1">實作 <code>IModuleAssemblyInitializer</code> 介面註冊 Assembly Resolver 事件處理函式。</span>
</dd>
<dt data-target-cell="annotated-cell-3" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-3" data-code-lines="15,16,17,18,19,20,21" data-code-annotation="2">實作 <code>IModuleAssemblyCleanup</code> 介面移除 Assembly Resolver 事件處理函式。</span>
</dd>
<dt data-target-cell="annotated-cell-3" data-target-annotation="3">3</dt>
<dd>
<span data-code-cell="annotated-cell-3" data-code-lines="31,32,33,34" data-code-annotation="3">針對 gRPC-Web client 套件相依 <code>Systems.Buffers.dll</code> 的 Assembly Resolver 實作，直接載入同目錄由 MSBuild 一起 copy 過來的 dll 版本。</span>
</dd>
<dt data-target-cell="annotated-cell-3" data-target-annotation="4">4</dt>
<dd>
<span data-code-cell="annotated-cell-3" data-code-lines="36,37,38,39" data-code-annotation="4">針對 <code>Systems.Buffers</code> 相依 <code>System.Runtime.CompilerServices.Unsafe.dll</code> 的 Assembly Resolver 實作，直接載入同目錄由 MSBuild 一起 copy 過來的 dll 版本。</span>
</dd>
</dl>
</section></section>
<section>
<section id="asp.net-core-整合-powershell-hosting-environment" class="title-slide slide level1 center">
<h1>ASP.NET Core 整合 PowerShell Hosting Environment</h1>

</section>
<section id="asp.net-core-整合-powershell-hosting-environment-1" class="slide level2">
<h2>ASP.NET Core 整合 PowerShell Hosting Environment</h2>
<ul>
<li>ASP.NET Core 3.1+ 的專案透過 <a href="http://www.nuget.org/packages/Microsoft.PowerShell.SDK"><code>Microsoft.PowerShell.SDK</code> nuget 套件</a>整合 <a href="http://learn.microsoft.com/powershell/scripting/dev-cross-plat/choosing-the-right-nuget-package#microsoftpowershellsdk">PowerShell Hosting runtime環境</a>，使 C# 應用以 <a href="https://learn.microsoft.com/powershell/scripting/developer/hosting/adding-and-invoking-commands">PowerShell C# API 執行 PowerShell script 或 PowerShell Cmdlet 指令</a>。</li>
</ul>
</section>
<section id="asp.net-core-minimal-api-整合執行-powershell-script-範例" class="slide level2 small scrollable">
<h2>ASP.NET Core Minimal API 整合執行 PowerShell Script 範例</h2>
<h3 id="demo-3"><strong><em>Demo</em></strong></h3>
<p><a href="http://github.com/windperson/BinaryPwshModuleDemo">範例程式碼 GitHub</a></p>
<p>此範例程式為一個檢查執行環境中兩個目錄是否有同樣檔案的 Web API，透過一個 PowerShell script 來執行真正檔案比對的工作。</p>
<p>此 PowerShell script 在先前的 <a href="https://github.com/windperson/DemoPester/blob/main/Demo1to1MappingTestModule/Production/ProductFeatures/SysAdminUtil/DuplicateFilesFinder.psm1">Pester test case 範例專案中提供</a>並且已有<a href="https://github.com/windperson/DemoPester/blob/main/Demo1to1MappingTestModule/Production_test/ProductFeatures/SysAdminUtil/DuplicateFilesFinder.Tests.ps1">驗證行為的測試案例</a>。</p>
<div class="quarto-figure quarto-figure-center">
<figure>
<p><img data-src="./04_AspNetCore_Host/pics/cli_run_Duplicate_File_Finder.png" class="quarto-figure quarto-figure-center" style="height:100.0%"></p>
</figure>
</div>
<p>使用 PowerShell 來撰寫取得所有有特定副檔名的檔案邏輯，比單純使用 C# 簡單:</p>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>src\DemoWebApi\PwshScripts\DuplicateFilesFinder.psm1</strong></pre>
</div>
<div class="sourceCode" id="cb3" data-filename="src\DemoWebApi\PwshScripts\DuplicateFilesFinder.psm1" data-code-line-numbers="7"><pre class="sourceCode numberSource powershell ps1 number-lines code-with-copy"><code class="sourceCode powershell"><span id="cb3-1"><a href=""></a><span class="kw">function</span> Get-Files <span class="op">{</span></span>
<span id="cb3-2"><a href=""></a>    <span class="op">[</span>SuppressMessage<span class="op">(</span><span class="st">'PSUseSingularNouns'</span><span class="op">,</span> <span class="st">''</span><span class="op">)]</span></span>
<span id="cb3-3"><a href=""></a>    <span class="kw">param</span> <span class="op">(</span></span>
<span id="cb3-4"><a href=""></a>        <span class="op">[</span><span class="dt">string</span><span class="op">]</span><span class="va">$Path</span><span class="op">,</span></span>
<span id="cb3-5"><a href=""></a>        <span class="op">[</span><span class="dt">string</span><span class="op">]</span><span class="va">$Extension</span></span>
<span id="cb3-6"><a href=""></a>    <span class="op">)</span></span>
<span id="cb3-7"><a href=""></a>    <span class="cf">return</span> <span class="fu">Get-ChildItem</span> <span class="op">-</span>Path <span class="va">$Path</span> <span class="op">-</span>Recurse <span class="op">-</span>File <span class="op">-</span>Filter <span class="st">"*.</span><span class="va">$Extension</span><span class="st">"</span></span>
<span id="cb3-8"><a href=""></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>也可以使用PowerShell 己提供的 <a href="http://learn.microsoft.com/powershell/module/microsoft.powershell.utility/get-filehash"><code>Get-FileHash</code> Cmdlet</a> 取得檔案的 Hash 值來快速判斷檔案是否相同:</p>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>src\DemoWebApi\PwshScripts\DuplicateFilesFinder.psm1</strong></pre>
</div>
<div class="sourceCode" id="cb4" data-filename="src\DemoWebApi\PwshScripts\DuplicateFilesFinder.psm1" data-code-line-numbers="8"><pre class="sourceCode numberSource powershell ps1 number-lines code-with-copy"><code class="sourceCode powershell"><span id="cb4-1"><a href=""></a><span class="kw">function</span> Get-FileContentHash <span class="op">{</span></span>
<span id="cb4-2"><a href=""></a>    <span class="op">[</span>SuppressMessage<span class="op">(</span><span class="st">'PSAvoidUsingBrokenHashAlgorithms'</span><span class="op">,</span> <span class="st">''</span><span class="op">,</span> </span>
<span id="cb4-3"><a href=""></a>        Justification <span class="op">=</span> <span class="st">'MD5 is just used for file hash comparison'</span><span class="op">)]</span></span>
<span id="cb4-4"><a href=""></a>    <span class="kw">param</span> <span class="op">(</span></span>
<span id="cb4-5"><a href=""></a>        <span class="op">[</span>Parameter<span class="op">(</span>Mandatory <span class="op">=</span> <span class="va">$true</span><span class="op">)]</span></span>
<span id="cb4-6"><a href=""></a>        <span class="op">[</span>System<span class="op">.</span><span class="fu">IO</span><span class="op">.</span><span class="fu">FileInfo</span><span class="op">]</span><span class="va">$FilePath</span></span>
<span id="cb4-7"><a href=""></a>    <span class="op">)</span></span>
<span id="cb4-8"><a href=""></a>    <span class="cf">return</span> Get-FileHash <span class="op">-</span>Algorithm MD5 <span class="op">-</span>Path <span class="va">$FilePath</span> <span class="co"># -SilentlyContinue</span></span>
<span id="cb4-9"><a href=""></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="section-1" class="slide level2 small scrollable">
<h2></h2>
<p>原本在 PowrShell script 裡使用的是 PowerShell 定義的自訂 Class 類別，因此在執行完畢回傳 PowerShell 物件直接使用 <a href="https://learn.microsoft.com/dotnet/csharp/advanced-topics/interop/using-type-dynamic"><strong><code>dynamic</code></strong> keyword</a> 寫法簡化取得 FilePath1 &amp; FilePath2 屬性值程式碼。</p>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>src\DemoWebApi\Services\DuplicateFileFinderInvokeService.cs</strong></pre>
</div>
<div class="sourceCode" id="annotated-cell-6" data-filename="src\DemoWebApi\Services\DuplicateFileFinderInvokeService.cs"><pre class="sourceCode csharp cs code-annotation-code code-with-copy code-annotated"><code class="sourceCode cs"><span id="annotated-cell-6-1"><a href="#annotated-cell-6-1" aria-hidden="true" tabindex="-1"></a><span class="dt">var</span> result <span class="op">=</span></span>
<span id="annotated-cell-6-2"><a href="#annotated-cell-6-2" aria-hidden="true" tabindex="-1"></a>    ps<span class="op">.</span><span class="fu">Invoke</span><span class="op">(</span>input<span class="op">:</span> <span class="kw">null</span><span class="op">,</span> settings<span class="op">:</span> psInvocationSettings<span class="op">)</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-6" data-target-annotation="1" onclick="event.preventDefault();" href="">1</a><span id="annotated-cell-6-3" class="code-annotation-target"><a href="#annotated-cell-6-3" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">FirstOrDefault</span><span class="op">()?.</span><span class="fu">BaseObject</span> <span class="kw">as</span> <span class="dt">object</span><span class="op">[];</span></span>
<span id="annotated-cell-6-4"><a href="#annotated-cell-6-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-6-5"><a href="#annotated-cell-6-5" aria-hidden="true" tabindex="-1"></a><span class="dt">var</span> duplicateFileResults <span class="op">=</span> <span class="kw">new</span> List<span class="op">&lt;</span>DuplicateFileResult<span class="op">&gt;(</span>result<span class="op">.</span><span class="fu">Length</span><span class="op">);</span></span>
<span id="annotated-cell-6-6"><a href="#annotated-cell-6-6" aria-hidden="true" tabindex="-1"></a><span class="co">// use dynamic to make simpler coding style to avoid reflection</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-6" data-target-annotation="2" onclick="event.preventDefault();" href="">2</a><span id="annotated-cell-6-7" class="code-annotation-target"><a href="#annotated-cell-6-7" aria-hidden="true" tabindex="-1"></a><span class="kw">foreach</span> <span class="op">(</span>dynamic duplicateFileInfo <span class="kw">in</span> result<span class="op">)</span></span>
<span id="annotated-cell-6-8"><a href="#annotated-cell-6-8" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="annotated-cell-6-9"><a href="#annotated-cell-6-9" aria-hidden="true" tabindex="-1"></a>    <span class="dt">var</span> duplicateFileResult <span class="op">=</span> <span class="kw">new</span> DuplicateFileResult</span>
<span id="annotated-cell-6-10"><a href="#annotated-cell-6-10" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-6" data-target-annotation="3" onclick="event.preventDefault();" href="">3</a><span id="annotated-cell-6-11" class="code-annotation-target"><a href="#annotated-cell-6-11" aria-hidden="true" tabindex="-1"></a>        SourceFilePath <span class="op">=</span> duplicateFileInfo<span class="op">.</span><span class="fu">FilePath1</span><span class="op">.</span><span class="fu">ToString</span><span class="op">(),</span></span>
<span id="annotated-cell-6-12"><a href="#annotated-cell-6-12" aria-hidden="true" tabindex="-1"></a>        CompareFilePath <span class="op">=</span> duplicateFileInfo<span class="op">.</span><span class="fu">FilePath2</span><span class="op">.</span><span class="fu">ToString</span><span class="op">()</span></span>
<span id="annotated-cell-6-13"><a href="#annotated-cell-6-13" aria-hidden="true" tabindex="-1"></a>    <span class="op">};</span></span>
<span id="annotated-cell-6-14"><a href="#annotated-cell-6-14" aria-hidden="true" tabindex="-1"></a>    duplicateFileResults<span class="op">.</span><span class="fu">Add</span><span class="op">(</span>duplicateFileResult<span class="op">);</span></span>
<span id="annotated-cell-6-15"><a href="#annotated-cell-6-15" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="annotated-cell-6-16"><a href="#annotated-cell-6-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-6-17"><a href="#annotated-cell-6-17" aria-hidden="true" tabindex="-1"></a><span class="kw">return</span> duplicateFileResults<span class="op">;</span></span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-6" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-6" data-code-lines="3" data-code-annotation="1">由於原本 PowerShell script function 定義的回傳值是單個物件陣列，所以取得回傳值順便先轉型成 <code>object[]</code> 陣列。</span>
</dd>
<dt data-target-cell="annotated-cell-6" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-6" data-code-lines="7" data-code-annotation="2">使用 <code>dynamic</code> 關鍵字來簡化原本 PowerShell 程式碼中定義的自訂 class 型別。</span>
</dd>
<dt data-target-cell="annotated-cell-6" data-target-annotation="3">3</dt>
<dd>
<span data-code-cell="annotated-cell-6" data-code-lines="11,12" data-code-annotation="3">就可以直接使用物件的屬性值（C#編譯器不檢查，如果寫錯就會有 runtime exception）。</span>
</dd>
</dl>
<div class="quarto-figure quarto-figure-center">
<figure>
<p><img data-src="./04_AspNetCore_Host/pics/pwsh_defined_class_return_object.png" class="quarto-figure quarto-figure-center" style="height:100.0%"></p>
</figure>
</div>
</section>
<section id="參考資料" class="slide level2">
<h2>參考資料</h2>
<p>[TBD]</p>
</section>
<section id="q-a" class="slide level2 center-xy">
<h2>Q &amp; A</h2>
<p>Any Questions?🙋‍♂️🙋‍♀️</p>

</section></section>
    </div>
  <div class="quarto-auto-generated-content" style="display: none;">
<div class="footer footer-default">

</div>
</div></div>

  <script>window.backupDefine = window.define; window.define = undefined;</script>
  <script src="index_files/libs/revealjs/dist/reveal.js"></script>
  <!-- reveal.js plugins -->
  <script src="index_files/libs/revealjs/plugin/quarto-line-highlight/line-highlight.js"></script>
  <script src="index_files/libs/revealjs/plugin/pdf-export/pdfexport.js"></script>
  <script src="index_files/libs/revealjs/plugin/reveal-menu/menu.js"></script>
  <script src="index_files/libs/revealjs/plugin/reveal-menu/quarto-menu.js"></script>
  <script src="index_files/libs/revealjs/plugin/quarto-support/support.js"></script>
  

  <script src="index_files/libs/revealjs/plugin/notes/notes.js"></script>
  <script src="index_files/libs/revealjs/plugin/search/search.js"></script>
  <script src="index_files/libs/revealjs/plugin/zoom/zoom.js"></script>
  <script src="index_files/libs/revealjs/plugin/math/math.js"></script>
  <script>window.define = window.backupDefine; window.backupDefine = undefined;</script>

  <script>

      // Full list of configuration options available at:
      // https://revealjs.com/config/
      Reveal.initialize({
'controlsAuto': true,
'previewLinksAuto': false,
'pdfSeparateFragments': false,
'autoAnimateEasing': "ease",
'autoAnimateDuration': 1,
'autoAnimateUnmatched': true,
'jumpToSlide': true,
'menu': {"side":"right","useTextContentForMissingTitles":true,"markers":false,"loadIcons":false,"custom":[{"title":"Tools","icon":"<i class=\"fas fa-gear\"></i>","content":"<ul class=\"slide-menu-items\">\n<li class=\"slide-tool-item active\" data-item=\"0\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.fullscreen(event)\"><kbd>f</kbd> Fullscreen</a></li>\n<li class=\"slide-tool-item\" data-item=\"1\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.speakerMode(event)\"><kbd>s</kbd> Speaker View</a></li>\n<li class=\"slide-tool-item\" data-item=\"2\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.overview(event)\"><kbd>o</kbd> Slide Overview</a></li>\n<li class=\"slide-tool-item\" data-item=\"3\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.togglePdfExport(event)\"><kbd>e</kbd> PDF Export Mode</a></li>\n<li class=\"slide-tool-item\" data-item=\"4\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.toggleScrollView(event)\"><kbd>r</kbd> Scroll View Mode</a></li>\n<li class=\"slide-tool-item\" data-item=\"5\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.keyboardHelp(event)\"><kbd>?</kbd> Keyboard Help</a></li>\n</ul>"}],"openButton":true},
'smaller': false,
 
        // Display controls in the bottom right corner
        controls: false,

        // Help the user learn the controls by providing hints, for example by
        // bouncing the down arrow when they first encounter a vertical slide
        controlsTutorial: false,

        // Determines where controls appear, "edges" or "bottom-right"
        controlsLayout: 'edges',

        // Visibility rule for backwards navigation arrows; "faded", "hidden"
        // or "visible"
        controlsBackArrows: 'faded',

        // Display a presentation progress bar
        progress: true,

        // Display the page number of the current slide
        slideNumber: 'c/t',

        // 'all', 'print', or 'speaker'
        showSlideNumber: 'all',

        // Add the current slide number to the URL hash so that reloading the
        // page/copying the URL will return you to the same slide
        hash: true,

        // Start with 1 for the hash rather than 0
        hashOneBasedIndex: false,

        // Flags if we should monitor the hash and change slides accordingly
        respondToHashChanges: true,

        // Push each slide change to the browser history
        history: true,

        // Enable keyboard shortcuts for navigation
        keyboard: true,

        // Enable the slide overview mode
        overview: true,

        // Disables the default reveal.js slide layout (scaling and centering)
        // so that you can use custom CSS layout
        disableLayout: false,

        // Vertical centering of slides
        center: false,

        // Enables touch navigation on devices with touch input
        touch: true,

        // Loop the presentation
        loop: false,

        // Change the presentation direction to be RTL
        rtl: false,

        // see https://revealjs.com/vertical-slides/#navigation-mode
        navigationMode: 'linear',

        // Randomizes the order of slides each time the presentation loads
        shuffle: false,

        // Turns fragments on and off globally
        fragments: true,

        // Flags whether to include the current fragment in the URL,
        // so that reloading brings you to the same fragment position
        fragmentInURL: false,

        // Flags if the presentation is running in an embedded mode,
        // i.e. contained within a limited portion of the screen
        embedded: false,

        // Flags if we should show a help overlay when the questionmark
        // key is pressed
        help: true,

        // Flags if it should be possible to pause the presentation (blackout)
        pause: true,

        // Flags if speaker notes should be visible to all viewers
        showNotes: false,

        // Global override for autoplaying embedded media (null/true/false)
        autoPlayMedia: null,

        // Global override for preloading lazy-loaded iframes (null/true/false)
        preloadIframes: null,

        // Number of milliseconds between automatically proceeding to the
        // next slide, disabled when set to 0, this value can be overwritten
        // by using a data-autoslide attribute on your slides
        autoSlide: 0,

        // Stop auto-sliding after user input
        autoSlideStoppable: true,

        // Use this method for navigation when auto-sliding
        autoSlideMethod: null,

        // Specify the average time in seconds that you think you will spend
        // presenting each slide. This is used to show a pacing timer in the
        // speaker view
        defaultTiming: null,

        // Enable slide navigation via mouse wheel
        mouseWheel: false,

        // The display mode that will be used to show slides
        display: 'block',

        // Hide cursor if inactive
        hideInactiveCursor: true,

        // Time before the cursor is hidden (in ms)
        hideCursorTime: 5000,

        // Opens links in an iframe preview overlay
        previewLinks: false,

        // Transition style (none/fade/slide/convex/concave/zoom)
        transition: 'none',

        // Transition speed (default/fast/slow)
        transitionSpeed: 'default',

        // Transition style for full page slide backgrounds
        // (none/fade/slide/convex/concave/zoom)
        backgroundTransition: 'none',

        // Number of slides away from the current that are visible
        viewDistance: 3,

        // Number of slides away from the current that are visible on mobile
        // devices. It is advisable to set this to a lower number than
        // viewDistance in order to save resources.
        mobileViewDistance: 2,

        // The "normal" size of the presentation, aspect ratio will be preserved
        // when the presentation is scaled to fit different resolutions. Can be
        // specified using percentage units.
        width: 1200,

        height: 900,

        // Factor of the display size that should remain empty around the content
        margin: 0.1,

        math: {
          mathjax: 'https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/MathJax.js',
          config: 'TeX-AMS_HTML-full',
          tex2jax: {
            inlineMath: [['\\(','\\)']],
            displayMath: [['\\[','\\]']],
            balanceBraces: true,
            processEscapes: false,
            processRefs: true,
            processEnvironments: true,
            preview: 'TeX',
            skipTags: ['script','noscript','style','textarea','pre','code'],
            ignoreClass: 'tex2jax_ignore',
            processClass: 'tex2jax_process'
          },
        },

        // reveal.js plugins
        plugins: [QuartoLineHighlight, PdfExport, RevealMenu, QuartoSupport,

          RevealMath,
          RevealNotes,
          RevealSearch,
          RevealZoom
        ]
      });
    </script>
    <script id="quarto-html-after-body" type="application/javascript">
    window.document.addEventListener("DOMContentLoaded", function (event) {
      const toggleBodyColorMode = (bsSheetEl) => {
        const mode = bsSheetEl.getAttribute("data-mode");
        const bodyEl = window.document.querySelector("body");
        if (mode === "dark") {
          bodyEl.classList.add("quarto-dark");
          bodyEl.classList.remove("quarto-light");
        } else {
          bodyEl.classList.add("quarto-light");
          bodyEl.classList.remove("quarto-dark");
        }
      }
      const toggleBodyColorPrimary = () => {
        const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
        if (bsSheetEl) {
          toggleBodyColorMode(bsSheetEl);
        }
      }
      toggleBodyColorPrimary();  
      const tabsets =  window.document.querySelectorAll(".panel-tabset-tabby")
      tabsets.forEach(function(tabset) {
        const tabby = new Tabby('#' + tabset.id);
      });
      const isCodeAnnotation = (el) => {
        for (const clz of el.classList) {
          if (clz.startsWith('code-annotation-')) {                     
            return true;
          }
        }
        return false;
      }
      const onCopySuccess = function(e) {
        // button target
        const button = e.trigger;
        // don't keep focus
        button.blur();
        // flash "checked"
        button.classList.add('code-copy-button-checked');
        var currentTitle = button.getAttribute("title");
        button.setAttribute("title", "Copied!");
        let tooltip;
        if (window.bootstrap) {
          button.setAttribute("data-bs-toggle", "tooltip");
          button.setAttribute("data-bs-placement", "left");
          button.setAttribute("data-bs-title", "Copied!");
          tooltip = new bootstrap.Tooltip(button, 
            { trigger: "manual", 
              customClass: "code-copy-button-tooltip",
              offset: [0, -8]});
          tooltip.show();    
        }
        setTimeout(function() {
          if (tooltip) {
            tooltip.hide();
            button.removeAttribute("data-bs-title");
            button.removeAttribute("data-bs-toggle");
            button.removeAttribute("data-bs-placement");
          }
          button.setAttribute("title", currentTitle);
          button.classList.remove('code-copy-button-checked');
        }, 1000);
        // clear code selection
        e.clearSelection();
      }
      const getTextToCopy = function(trigger) {
          const codeEl = trigger.previousElementSibling.cloneNode(true);
          for (const childEl of codeEl.children) {
            if (isCodeAnnotation(childEl)) {
              childEl.remove();
            }
          }
          return codeEl.innerText;
      }
      const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
        text: getTextToCopy
      });
      clipboard.on('success', onCopySuccess);
      if (window.document.getElementById('quarto-embedded-source-code-modal')) {
        const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
          text: getTextToCopy,
          container: window.document.getElementById('quarto-embedded-source-code-modal')
        });
        clipboardModal.on('success', onCopySuccess);
      }
        var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
        var mailtoRegex = new RegExp(/^mailto:/);
          var filterRegex = new RegExp('/' + window.location.host + '/');
        var isInternal = (href) => {
            return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
        }
        // Inspect non-navigation links and adorn them if external
     	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
        for (var i=0; i<links.length; i++) {
          const link = links[i];
          if (!isInternal(link.href)) {
            // undo the damage that might have been done by quarto-nav.js in the case of
            // links that we want to consider external
            if (link.dataset.originalHref !== undefined) {
              link.href = link.dataset.originalHref;
            }
          }
        }
      function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
        const config = {
          allowHTML: true,
          maxWidth: 500,
          delay: 100,
          arrow: false,
          appendTo: function(el) {
              return el.closest('section.slide') || el.parentElement;
          },
          interactive: true,
          interactiveBorder: 10,
          theme: 'light-border',
          placement: 'bottom-start',
        };
        if (contentFn) {
          config.content = contentFn;
        }
        if (onTriggerFn) {
          config.onTrigger = onTriggerFn;
        }
        if (onUntriggerFn) {
          config.onUntrigger = onUntriggerFn;
        }
          config['offset'] = [0,0];
          config['maxWidth'] = 700;
        window.tippy(el, config); 
      }
      const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
      for (var i=0; i<noterefs.length; i++) {
        const ref = noterefs[i];
        tippyHover(ref, function() {
          // use id or data attribute instead here
          let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
          try { href = new URL(href).hash; } catch {}
          const id = href.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note) {
            return note.innerHTML;
          } else {
            return "";
          }
        });
      }
          let selectedAnnoteEl;
          const selectorForAnnotation = ( cell, annotation) => {
            let cellAttr = 'data-code-cell="' + cell + '"';
            let lineAttr = 'data-code-annotation="' +  annotation + '"';
            const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
            return selector;
          }
          const selectCodeLines = (annoteEl) => {
            const doc = window.document;
            const targetCell = annoteEl.getAttribute("data-target-cell");
            const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
            const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
            const lines = annoteSpan.getAttribute("data-code-lines").split(",");
            const lineIds = lines.map((line) => {
              return targetCell + "-" + line;
            })
            let top = null;
            let height = null;
            let parent = null;
            if (lineIds.length > 0) {
                //compute the position of the single el (top and bottom and make a div)
                const el = window.document.getElementById(lineIds[0]);
                top = el.offsetTop;
                height = el.offsetHeight;
                parent = el.parentElement.parentElement;
              if (lineIds.length > 1) {
                const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
                const bottom = lastEl.offsetTop + lastEl.offsetHeight;
                height = bottom - top;
              }
              if (top !== null && height !== null && parent !== null) {
                // cook up a div (if necessary) and position it 
                let div = window.document.getElementById("code-annotation-line-highlight");
                if (div === null) {
                  div = window.document.createElement("div");
                  div.setAttribute("id", "code-annotation-line-highlight");
                  div.style.position = 'absolute';
                  parent.appendChild(div);
                }
                div.style.top = top - 2 + "px";
                div.style.height = height + 4 + "px";
                div.style.left = 0;
                let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
                if (gutterDiv === null) {
                  gutterDiv = window.document.createElement("div");
                  gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                  gutterDiv.style.position = 'absolute';
                  const codeCell = window.document.getElementById(targetCell);
                  const gutter = codeCell.querySelector('.code-annotation-gutter');
                  gutter.appendChild(gutterDiv);
                }
                gutterDiv.style.top = top - 2 + "px";
                gutterDiv.style.height = height + 4 + "px";
              }
              selectedAnnoteEl = annoteEl;
            }
          };
          const unselectCodeLines = () => {
            const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
            elementsIds.forEach((elId) => {
              const div = window.document.getElementById(elId);
              if (div) {
                div.remove();
              }
            });
            selectedAnnoteEl = undefined;
          };
            // Handle positioning of the toggle
        window.addEventListener(
          "resize",
          throttle(() => {
            elRect = undefined;
            if (selectedAnnoteEl) {
              selectCodeLines(selectedAnnoteEl);
            }
          }, 10)
        );
        function throttle(fn, ms) {
        let throttle = false;
        let timer;
          return (...args) => {
            if(!throttle) { // first call gets through
                fn.apply(this, args);
                throttle = true;
            } else { // all the others get throttled
                if(timer) clearTimeout(timer); // cancel #2
                timer = setTimeout(() => {
                  fn.apply(this, args);
                  timer = throttle = false;
                }, ms);
            }
          };
        }
          // Attach click handler to the DT
          const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
          for (const annoteDlNode of annoteDls) {
            annoteDlNode.addEventListener('click', (event) => {
              const clickedEl = event.target;
              if (clickedEl !== selectedAnnoteEl) {
                unselectCodeLines();
                const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
                if (activeEl) {
                  activeEl.classList.remove('code-annotation-active');
                }
                selectCodeLines(clickedEl);
                clickedEl.classList.add('code-annotation-active');
              } else {
                // Unselect the line
                unselectCodeLines();
                clickedEl.classList.remove('code-annotation-active');
              }
            });
          }
      const findCites = (el) => {
        const parentEl = el.parentElement;
        if (parentEl) {
          const cites = parentEl.dataset.cites;
          if (cites) {
            return {
              el,
              cites: cites.split(' ')
            };
          } else {
            return findCites(el.parentElement)
          }
        } else {
          return undefined;
        }
      };
      var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
      for (var i=0; i<bibliorefs.length; i++) {
        const ref = bibliorefs[i];
        const citeInfo = findCites(ref);
        if (citeInfo) {
          tippyHover(citeInfo.el, function() {
            var popup = window.document.createElement('div');
            citeInfo.cites.forEach(function(cite) {
              var citeDiv = window.document.createElement('div');
              citeDiv.classList.add('hanging-indent');
              citeDiv.classList.add('csl-entry');
              var biblioDiv = window.document.getElementById('ref-' + cite);
              if (biblioDiv) {
                citeDiv.innerHTML = biblioDiv.innerHTML;
              }
              popup.appendChild(citeDiv);
            });
            return popup.innerHTML;
          });
        }
      }
    });
    </script>
    

</body></html>